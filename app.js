(()=>{"use strict";var e={3165:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(4310);a.initVersionManager();const c=a.getVersion();console.log(`______  _______________________  ___                                         \n___   |/  /_  ____/_  ___/__   |/  /_____ _____________ _______ _____________\n__  /|_/ /_  /    _____ \\__  /|_/ /_  __  /_  __ \\  __  /_  __  /  _ \\_  ___/\n_  /  / / / /___  ____/ /_  /  / / / /_/ /_  / / / /_/ /_  /_/ //  __/  /    \n/_/  /_/  \\____/  /____/ /_/  /_/  \\__,_/ /_/ /_/\\__,_/ _\\__, / \\___//_/     \n________                                                /____/                                          \n___  __ \\_____ ____________ ________________ \n__  / / /  __  /  _ \\_  __  __ \\  __ \\_  __ \\\n_  /_/ // /_/ //  __/  / / / / / /_/ /  / / /\n/_____/ \\__,_/ \\___//_/ /_/ /_/\\____//_/ /_/   \n\n + Released under the AGPL-3.0 License\n + Copyright 2022 Suwings\n + Version ${c}\n`);const u=o(n(3685)),l=n(3952),f=o(n(3018));f.default.info("欢迎使用 MCSManager 守护进程");const d=n(8222),p=i(n(1018)),h=i(n(9815)),m=i(n(8742)),g=o(n(9597));n(559).initDependent(),d.globalConfiguration.load();const _=d.globalConfiguration.config,y=h.initKoa();y.on("error",(e=>{}));const w=u.default.createServer(y.callback());w.listen(_.port,_.ip);const k=new l.Server(w,{serveClient:!1,pingInterval:5e3,pingTimeout:5e3,cookie:!1,path:"/socket.io",cors:{origin:"*",methods:["GET","POST","PUT","DELETE"]}});try{f.default.info("正在读取本地应用实例中"),g.default.loadInstances(),f.default.info(`所有应用实例已加载，总计 ${g.default.instances.size} 个`)}catch(e){f.default.error("读取本地实例文件失败:",e),process.exit(-1)}k.on("connection",(e=>{f.default.info(`会话 ${e.id}(${e.handshake.address}) 已连接.`),m.addGlobalSocket(e),p.navigation(e),e.on("disconnect",(()=>{m.delGlobalSocket(e);for(const t of e.eventNames())e.removeAllListeners(t);f.default.info(`会话 ${e.id}(${e.handshake.address}) 已断开`)}))})),process.on("uncaughtException",(function(e){f.default.error("错误报告 (uncaughtException):",e)})),process.on("unhandledRejection",((e,t)=>{f.default.error("错误报告 (unhandledRejection):",e,t)})),f.default.info("守护进程现已成功启动"),f.default.info("================================"),f.default.info("参考文档：https://docs.mcsmanager.com/"),f.default.info(`访问地址：http://${_.ip?_.ip:"localhost"}:${_.port}`),f.default.info(`访问密钥：${_.key}`),f.default.info("密钥作为守护进程唯一认证手段"),f.default.info("================================"),console.log(""),n(9095),["SIGTERM","SIGINT","SIGQUIT"].forEach((function(e){process.on(e,(async function(){try{console.log("\n\n\n\n"),f.default.warn(`${e} close process signal detected.`),await g.default.exit(),f.default.info("The data is saved, thanks for using, goodbye!"),f.default.info("Closed.")}catch(e){f.default.error("ERROR:",e)}finally{process.exit(0)}}))}))},5046:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.decompress=t.compress=void 0;const a=o(n(4470)),c=o(n(1017)),u=(i(n(7416)),o(n(2081)),o(n(2037))),l=o(n(5500)),f=o(n(7601));u.default.platform(),t.compress=async function(e,t,n){return await function(e,t,n="utf-8"){return new Promise(((n,s)=>{const r=a.default.createWriteStream(e),i=l.default("zip",{zlib:{level:9}});t.forEach((e=>{var t;const n=c.default.normalize(c.default.basename(e));a.default.existsSync(e)&&((null===(t=a.default.statSync(e))||void 0===t?void 0:t.isDirectory())?i.directory(e,n):i.file(e,{name:n}))})),r.on("close",(function(){n(!0)})),i.on("warning",(function(e){s(e)})),i.on("error",(function(e){s(e)})),i.pipe(r),i.finalize()}))}(e,t,n)},t.decompress=async function(e,t,n){return await function(e,t,n="utf-8"){return new Promise((async(s,r)=>{const i=new f.default.async({file:e,nameEncoding:n});a.default.existsSync(t)||a.default.mkdirsSync(t);try{return await i.extract(null,t),s(!0)}catch(e){r(e)}i.close().then((()=>{})).catch((()=>{}))}))}(e,t,n)}},6473:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class n{static set(e,t){n.map.set(e,t)}static get(e,t){return n.map.has(e)?n.map.get(e):t}static del(e){return n.map.delete(e)}}t.default=n,n.map=new Map},2764:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.listenMap=new Map}requestForward(e,t){if(this.listenMap.has(t)){const n=this.listenMap.get(t);for(const t of n)if(t.id===e.id)throw new Error(`此 Socket ${e.id} 已经存在于指定实例监听表中`);n.push(e)}else this.listenMap.set(t,[e])}cannelForward(e,t){if(!this.listenMap.has(t))throw new Error(`指定 ${t} 并不存在于监听表中`);const n=this.listenMap.get(t);n.forEach(((t,s)=>{t.id===e.id&&n.splice(s,1)}))}forward(e,t){this.listenMap.get(e).forEach((e=>{e&&e.connected&&e.emit("instance/stdout",t)}))}forwardViaCallback(e,t){this.listenMap.has(e)&&this.listenMap.get(e).forEach((e=>{e&&e.connected&&t(e)}))}hasListenInstance(e){return this.listenMap.has(e)&&this.listenMap.get(e).length>0}}},1787:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1808));t.default=class{constructor(e,t){this.port=e,this.host=t,this.status={online:null,version:null,motd:null,current_players:null,max_players:null,latency:null}}getStatus(){return new Promise(((e,t)=>{var n=(new Date).getTime();const s=r.default.connect(this.port,this.host,(()=>{this.status.latency=Math.round((new Date).getTime()-n);let e=Buffer.from([254,1]);s.write(e)}));s.on("data",(t=>{var n=t.toString().split("\0\0");this.status={host:this.host,port:this.port,status:!0,version:n[2].replace(/\u0000/g,""),motd:n[3].replace(/\u0000/g,""),current_players:n[4].replace(/\u0000/g,""),max_players:n[5].replace(/\u0000/g,""),latency:this.status.latency},function(e){let t=e.replace(/\u0000/g,"");Buffer.from(t)}(n[3]),s.end(),e(this.status)})),s.on("end",(()=>{})),s.on("error",(e=>{t(e)}))}))}async asyncStatus(){return await this.getStatus()}}},5927:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.killProcess=void 0;const r=n(2081),i=s(n(2037));t.killProcess=function(e,t,n){try{if("win32"===i.default.platform())return r.execSync(`taskkill /PID ${e} /T /F`),console.log(`进程 ${e} 已使用系统指令强制终止进程`),!0;if("linux"===i.default.platform())return r.execSync(`kill -s 9 ${e}`),console.log(`进程 ${e} 已使用系统指令强制终止进程`),!0}catch(e){return n?t.kill(n):t.kill("SIGKILL")}return n?t.kill(n):t.kill("SIGKILL")}},3459:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QueryWrapper=t.LocalFileSource=t.MySqlSource=t.QueryMapWrapper=void 0,t.QueryMapWrapper=class{constructor(e){this.map=e}select(e){const t=[];return this.map.forEach((n=>{e(n)&&t.push(n)})),t}page(e,t=1,n=10){const s=(t-1)*n,r=s+n;let i=e.length,o=0;for(;i>0;)i-=n,o++;return{page:t,pageSize:n,maxPage:o,data:e.slice(s,r)}}},t.MySqlSource=class{},t.LocalFileSource=class{constructor(e){this.data=e}selectPage(e,t=1,n=10){const s=[];return this.data.forEach((t=>{for(const n in e){const s=t[n],r=e[n];if("%"==r[0]){if(!s.includes(r.slice(1,r.length-1)))return!1}else if(r!==s)return!1}s.push(t)})),this.page(s,t,n)}page(e,t=1,n=10){const s=(t-1)*n,r=s+n;let i=e.length,o=0;for(;i>0;)i-=n,o++;return{page:t,pageSize:n,maxPage:o,total:e.length,data:e.slice(s,r)}}select(e){return null}update(e,t){}delete(e){}insert(e){}},t.QueryWrapper=class{constructor(e){this.dataSource=e}selectPage(e,t=1,n=10){return this.dataSource.selectPage(e,t,n)}}},5103:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.systemInfo=void 0;const r=s(n(2037)),i=s(n(7411)),o=s(n(7147)),a={type:r.default.type(),hostname:r.default.hostname(),platform:r.default.platform(),release:r.default.release(),uptime:r.default.uptime(),cwd:process.cwd(),loadavg:r.default.loadavg(),freemem:0,cpuUsage:0,memUsage:0,totalmem:0,processCpu:0,processMem:0};function c(){a.freemem=r.default.freemem(),a.totalmem=r.default.totalmem(),a.memUsage=(r.default.totalmem()-r.default.freemem())/r.default.totalmem(),i.default.cpuUsage((e=>a.cpuUsage=e))}setInterval((()=>"linux"===r.default.platform()?function(){var e;try{const t=o.default.readFileSync("/proc/meminfo",{encoding:"utf-8"}).split("\n"),n={};t.forEach((e=>{const t=e.split(":");if(2===t.length){const e=t[0].replace(/ /gim,"").replace(/\t/gim,"").trim().toLowerCase();let s=t[1].replace(/ /gim,"").replace(/\t/gim,"").trim().toLowerCase();s=s.replace(/kb/gim,"").replace(/mb/gim,"").replace(/gb/gim,"");let r=parseInt(s);isNaN(r)&&(r=0),n[e]=r}}));const s=null!==(e=n.memavailable)&&void 0!==e?e:n.memfree,r=n.memtotal;a.freemem=1024*s,a.totalmem=1024*r,a.memUsage=(a.totalmem-a.freemem)/a.totalmem,i.default.cpuUsage((e=>a.cpuUsage=e))}catch(e){c()}}():"win32"===r.default.platform()?(a.freemem=r.default.freemem(),a.totalmem=r.default.totalmem(),a.memUsage=(r.default.totalmem()-r.default.freemem())/r.default.totalmem(),void i.default.cpuUsage((e=>a.cpuUsage=e))):c()),3e3),t.systemInfo=function(){return a}},2270:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1017)),i=s(n(4470));class o{checkFileName(e){const t=["\\","/",".."];for(const n of t)if(e.includes(n))return!1;return!0}store(e,t,n){const s=r.default.join(o.STIRAGE_DATA_PATH,e);if(i.default.existsSync(s)||i.default.mkdirsSync(s),!this.checkFileName(t))throw new Error(`UUID ${t} 不符合规范`);const a=r.default.join(s,`${t}.json`),c=JSON.stringify(n,null,4);i.default.writeFileSync(a,c,{encoding:"utf-8"})}defineAttr(e,t){for(const n of Object.keys(e)){const s=t[n];void 0!==s&&(s instanceof Array?e[n]=s:s instanceof Object&&"object"==typeof s?this.defineAttr(e[n],s):e[n]=s)}return e}load(e,t,n){const s=r.default.join(o.STIRAGE_DATA_PATH,e);if(i.default.existsSync(s)||i.default.mkdirsSync(s),!this.checkFileName(n))throw new Error(`UUID ${n} 不符合规范`);const a=r.default.join(s,`${n}.json`);if(!i.default.existsSync(a))return null;const c=i.default.readFileSync(a,{encoding:"utf-8"}),u=JSON.parse(c),l=new t;return this.defineAttr(l,u)}list(e){const t=r.default.join(o.STIRAGE_DATA_PATH,e);i.default.existsSync(t)||i.default.mkdirsSync(t);const n=i.default.readdirSync(t),s=new Array;return n.forEach((e=>{s.push(e.replace(r.default.extname(e),""))})),s}delete(e,t){const n=r.default.join(o.STIRAGE_DATA_PATH,e,`${t}.json`);i.default.existsSync(n)&&i.default.removeSync(n)}}o.STIRAGE_DATA_PATH=r.default.normalize(r.default.join(process.cwd(),"data")),o.STIRAGE_INDEX_PATH=r.default.normalize(r.default.join(process.cwd(),"data","index")),t.default=new o},4397:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.configureEntityParams=void 0,t.configureEntityParams=function(e,t,n,s){var r;const i=null!==(r=e[n])&&void 0!==r?r:null,o=null!=t[n]?t[n]:i;if(s!==Number)if(s!==String)if(s!==Boolean)if(s!==Array)e[n]=s?s(o):o;else{if(null==o)return e[n]=null;if(!(o instanceof Array))throw new Error("ConfigureEntityParams Error: Expected type to be Array, but got "+typeof o)}else e[n]=null!=o&&Boolean(o);else e[n]=null==o?null:String(o);else if(""===o||null==o)e[n]=null;else{if(isNaN(Number(o)))throw new Error("ConfigureEntityParams Error: Expected type to be Number, but got "+typeof o);e[n]=Number(o)}}},5018:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PTY_PATH=t.FILENAME_BLACKLIST=void 0;const r=s(n(2037)),i=s(n(1017)),o=i.default.normalize(i.default.join(process.cwd(),"lib","win32"===r.default.platform()?"pty.exe":"pty"));t.PTY_PATH=o,t.FILENAME_BLACKLIST=["\\","/",".","'",'"',"?","*","<",">"]},232:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e){this.info=e}async exec(e){}async stop(e){}}},8127:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.commandStringToArray=void 0,t.commandStringToArray=function(e){const t="{quotes}";let n=0,s=e.length;const r=[];function i(t){if(t!=n){const s=e.slice(n,t);return n=t,r.push(s)}}function o(t){for(let n=t+1;n<s;n++)if('"'===e[n])return n;throw new Error("错误的命令双引号，无法找到成对双引号，如需使用单个双引号请使用 {quotes} 符号")}if(function(){for(let t=n;t<s;t++){const a=e[t];if(" "!==a){if('"'===a&&(t=o(t)),t+1>=s){r.push(e.slice(n));break}}else i(t),n++}}(),0==r.length)throw new Error("错误的命令长度，请确保命令格式正确");for(const e in r){const n=r[e];for('"'===n[0]&&'"'===n[n.length-1]&&(r[e]=n.slice(1,n.length-1));-1!=r[e].indexOf(t);)r[e]=r[e].replace(t,'"')}return r}},5202:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(232));class i extends r.default{constructor(e){super("SendCommand"),this.cmd=e}async exec(e){return await e.execPreset("command",this.cmd)}}t.default=i},9659:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5275)),i=s(n(232)),o=s(n(699)),a=s(n(156)),c=s(n(3198)),u=s(n(1878)),l=s(n(3565)),f=s(n(9609)),d=s(n(717)),p=s(n(599)),h=s(n(6369)),m=s(n(1819)),g=s(n(3088)),_=s(n(3485)),y=s(n(8378)),w=s(n(7142));class k extends i.default{constructor(){super("FunctionDispatcher")}async exec(e){e.lifeCycleTaskManager.clearLifeCycleTask(),e.clearPreset(),e.lifeCycleTaskManager.registerLifeCycleTask(new m.default),e.setPreset("command",new d.default),e.setPreset("stop",new l.default),e.setPreset("kill",new f.default),e.setPreset("restart",new p.default),e.setPreset("update",new _.default),e.config.processType&&"general"!==e.config.processType||e.setPreset("start",new u.default),e.config.terminalOption.pty&&e.config.terminalOption.ptyWindowCol&&e.config.terminalOption.ptyWindowRow&&"general"===e.config.processType&&(e.setPreset("start",new y.default),e.setPreset("stop",new w.default),e.setPreset("resize",new c.default)),"docker"===e.config.processType&&(e.setPreset("resize",new c.default),e.setPreset("start",new h.default)),e.config.type.includes(r.default.TYPE_UNIVERSAL)&&e.setPreset("getPlayer",new c.default),e.config.type.includes(r.default.TYPE_MINECRAFT_JAVA)&&(e.setPreset("getPlayer",new a.default),e.lifeCycleTaskManager.registerLifeCycleTask(new o.default)),e.config.type.includes(r.default.TYPE_MINECRAFT_BEDROCK)&&(e.setPreset("getPlayer",new g.default),e.lifeCycleTaskManager.registerLifeCycleTask(new o.default))}}t.default=k},6369:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DockerProcessAdapter=void 0;const r=s(n(5275)),i=s(n(232)),o=s(n(4856)),a=s(n(3018)),c=n(1239),u=s(n(4470)),l=n(8127),f=s(n(1017)),d=process.getuid?process.getuid:()=>0,p=process.getgid?process.getgid:()=>0;class h extends Error{constructor(e){super(e)}}class m extends c.EventEmitter{constructor(e){super(),this.container=e}async start(e){try{await this.container.start();const{isTty:t,h:n,w:s}=e;t&&this.container.resize({h:n,w:s}),this.pid=this.container.id;const r=this.stream=await this.container.attach({stream:!0,stdout:!0,stderr:!0,stdin:!0});r.on("data",(e=>this.emit("data",e))),r.on("error",(e=>this.emit("data",e))),this.wait()}catch(e){throw this.kill(),e}}write(e){this.stream&&this.stream.write(e)}async kill(e){return await this.container.kill(),!0}async destroy(){try{await this.container.remove()}catch(e){}}wait(){this.container.wait((async e=>{await this.destroy(),this.emit("exit",e)}))}}t.DockerProcessAdapter=m;class g extends i.default{constructor(){super("DockerStartCommand")}async exec(e,t="Unknown"){if(!(e.config.startCommand&&e.config.cwd&&e.config.ie&&e.config.oe))return e.failure(new h("启动命令，输入输出编码或工作目录为空值"));if(!u.default.existsSync(e.absoluteCwdPath()))return e.failure(new h("工作目录并不存在"));try{e.setLock(!0),e.status(r.default.STATUS_STARTING),e.startCount++;const n=l.commandStringToArray(e.config.startCommand),s=e.absoluteCwdPath(),i=e.config.docker.ports,c={},u={};for(const e of i){const t=e.split("/");if(2!=t.length)continue;const n=t[0],s=t[1],r=n.split(":");2==r.length&&(c[`${r[1]}/${s}`]=[{HostPort:r[0]}],u[`${r[1]}/${s}`]={})}const h=e.config.docker.extraVolumes,g=[];for(const e of h){if(!e)continue;const t=e.split(":");if(2!=t.length)continue;let[n,s]=t;s=f.default.isAbsolute(s)?f.default.normalize(s):f.default.normalize(f.default.join("/workspace/",s)),n=f.default.isAbsolute(n)?f.default.normalize(n):f.default.normalize(f.default.join(process.cwd(),n)),g.push(`${n}:${s}`)}let _,y,w,k;e.config.docker.memory&&(_=1024*e.config.docker.memory*1024),e.config.docker.cpuUsage&&(y=10*e.config.docker.cpuUsage*1e3,w=1e6),e.config.docker.cpusetCpus&&(e.config.docker.cpusetCpus.split(",").forEach((e=>{if(isNaN(Number(e)))throw new Error(`非法的CPU核心指定: ${e}`)})),k=e.config.docker.cpusetCpus);let v=e.config.docker.containerName;if(v&&(v.length>64||v.length<2))throw new Error(`非法的容器名: ${v}`);a.default.info("----------------"),a.default.info(`会话 ${t}: 请求开启实例`),a.default.info(`实例标识符: [${e.instanceUuid}]`),a.default.info(`容器名称: [${v}]`),a.default.info(`启动命令: ${n.join(" ")}`),a.default.info(`工作目录: ${s}`),a.default.info(`网络模式: ${e.config.docker.networkMode}`),a.default.info(`端口映射: ${JSON.stringify(c)}`),g.length>0&&a.default.info(`额外挂载: ${JSON.stringify(g)}`),a.default.info(`网络别名: ${JSON.stringify(e.config.docker.networkAliases)}`),_&&a.default.info(`内存限制: ${_} MB`),a.default.info("类型: Docker 容器"),a.default.info("----------------");const P=e.config.terminalOption.pty,S=new o.default,T=await S.createContainer({name:v,Image:e.config.docker.image,AttachStdin:!0,AttachStdout:!0,AttachStderr:!0,Tty:P,User:`${d()}:${p()}`,WorkingDir:"/workspace/",Cmd:n,OpenStdin:!0,StdinOnce:!1,ExposedPorts:u,HostConfig:{Memory:_,Binds:[`${s}:/workspace/`,...g],AutoRemove:!0,CpusetCpus:k,CpuPeriod:w,CpuQuota:y,PortBindings:c,NetworkMode:e.config.docker.networkMode},NetworkingConfig:{EndpointsConfig:{[e.config.docker.networkMode]:{Aliases:e.config.docker.networkAliases}}}}),b=new m(T);await b.start({isTty:P,w:e.config.terminalOption.ptyWindowCol,h:e.config.terminalOption.ptyWindowCol}),e.started(b),a.default.info(`实例 ${e.instanceUuid} 成功启动.`)}catch(t){return e.instanceStatus=r.default.STATUS_STOP,e.releaseResources(),e.failure(t)}finally{e.setLock(!1)}}}t.default=g},717:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5135),i=s(n(232));class o extends i.default{constructor(){super("SendCommand")}async exec(e,t){return e.process||e.failure(new Error("命令执行失败，因为实例实际进程不存在.")),e.process.write(r.encode(t,e.config.oe)),2===e.config.crlf?e.process.write("\r\n"):e.process.write("\n")}}t.default=o},9609:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(232));class i extends r.default{constructor(){super("KillCommand")}async exec(e){e.process&&await e.process.kill("SIGKILL"),e.setLock(!1)}}t.default=i},599:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5275)),i=s(n(232));class o extends i.default{constructor(){super("GeneralRestartCommand")}async exec(e){try{e.println("INFO","重启实例计划开始执行..."),await e.execPreset("stop"),e.setLock(!0);const t=e.startCount,n=setInterval((async()=>{try{if(t!==e.startCount)throw new Error("重启实例状态错误，实例已被启动过，上次状态的重启计划取消");if(e.status()!==r.default.STATUS_STOPPING&&e.status()!==r.default.STATUS_STOP)throw new Error("重启实例状态错误，实例状态应该为停止中状态，现在变为正在运行，重启计划取消");e.status()===r.default.STATUS_STOP&&(e.println("INFO","检测到服务器已停止，正在重启实例..."),await e.execPreset("start"),e.setLock(!1),clearInterval(n))}catch(t){clearInterval(n),e.setLock(!1),e.failure(t)}}),1e3)}catch(t){e.setLock(!1),e.failure(t)}}}t.default=o},1878:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5275)),i=s(n(3018)),o=s(n(4470)),a=s(n(232)),c=s(n(1239)),u=n(2081),l=n(8127),f=n(5927);class d extends Error{constructor(e){super(e)}}class p extends c.default{constructor(e){super(),this.process=e,this.pid=this.process.pid,e.stdout.on("data",(e=>this.emit("data",e))),e.stderr.on("data",(e=>this.emit("data",e))),e.on("exit",(e=>this.emit("exit",e)))}write(e){return this.process.stdin.write(e)}kill(e){return f.killProcess(this.pid,this.process,e)}async destroy(){try{if(this.process&&this.process.stdout&&this.process.stderr){for(const e of this.process.stdout.eventNames())this.process.stdout.removeAllListeners(e);for(const e of this.process.stderr.eventNames())this.process.stderr.removeAllListeners(e);for(const e of this.process.eventNames())this.process.removeAllListeners(e);this.process.stdout.destroy(),this.process.stderr.destroy()}}catch(e){}}}class h extends a.default{constructor(){super("StartCommand")}async exec(e,t="Unknown"){if(!(e.config.startCommand&&e.config.cwd&&e.config.ie&&e.config.oe))return e.failure(new d("启动命令，输入输出编码或工作目录为空值"));if(!o.default.existsSync(e.absoluteCwdPath()))return e.failure(new d("工作目录并不存在"));try{e.setLock(!0),e.status(r.default.STATUS_STARTING),e.startCount++;const n=l.commandStringToArray(e.config.startCommand),s=n[0],o=n.slice(1);if(0===n.length)return e.failure(new d("无法启动实例，启动命令为空"));i.default.info("----------------"),i.default.info(`会话 ${t}: 请求开启实例.`),i.default.info(`实例标识符: [${e.instanceUuid}]`),i.default.info(`启动命令: ${JSON.stringify(n)}`),i.default.info(`工作目录: ${e.config.cwd}`),i.default.info("----------------");const a=u.spawn(s,o,{cwd:e.config.cwd,stdio:"pipe",windowsHide:!0});if(!a||!a.pid)throw e.println("ERROR",`检测到实例进程/容器启动失败（PID 为空），其可能的原因是：\n1. 实例启动命令编写错误，请前往实例设置界面检查启动命令与参数。\n2. 系统主机环境不正确或缺少环境，如 Java 环境等。\n\n原生启动命令：\n${e.config.startCommand}\n\n启动命令解析体:\n程序：${s}\n参数：${JSON.stringify(o)}\n\n请将此信息报告给管理员，技术人员或自行排查故障。\n`),new d("实例启动失败，请检查启动命令，主机环境和配置文件等");const c=new p(a);e.started(c),i.default.info(`实例 ${e.instanceUuid} 成功启动 PID: ${a.pid}.`),e.println("INFO","应用实例已运行，终端为普通终端模式，您可以在底部的命令输入框发送命令，不支持 Ctrl，Tab 等功能键")}catch(t){return e.instanceStatus=r.default.STATUS_STOP,e.releaseResources(),e.failure(t)}finally{e.setLock(!1)}}}t.default=h},3565:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5275)),i=s(n(232)),o=s(n(5202));class a extends i.default{constructor(){super("StopCommand")}async exec(e){const t=e.config.stopCommand;if(e.status()===r.default.STATUS_STOP||!e.process)return e.failure(new Error("实例未处于运行中状态，无法进行停止."));e.status(r.default.STATUS_STOPPING),"^c"==t.toLocaleLowerCase()?e.process.kill("SIGINT"):await e.exec(new o.default(t)),e.println("INFO",`已执行预设的关闭命令：${t}\n如果无法关闭实例请前往实例设置更改关闭实例的正确命令，比如 ^C，stop，end 等`);const n=e.startCount;return setTimeout((()=>{e.status()===r.default.STATUS_STOPPING&&e.startCount===n&&(e.println("ERROR","关闭命令已发出但长时间未能关闭实例，可能是实例关闭命令错误或实例进程假死导致，现在将恢复到运行中状态，可使用强制终止指令结束进程。"),e.status(r.default.STATUS_RUNNING))}),6e5),e}}t.default=a},3485:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5927),i=n(2081),o=s(n(3018)),a=s(n(5275)),c=s(n(232)),u=n(8127),l=s(n(5135));class f extends c.default{constructor(){super("GeneralUpdateCommand"),this.pid=null,this.process=null}stoped(e){e.asynchronousTask=null,e.setLock(!1),e.status(a.default.STATUS_STOP)}async exec(e){if(e.status()!==a.default.STATUS_STOP)return e.failure(new Error("实例状态不正确，无法执行更新任务，必须停止实例"));if(null!==e.asynchronousTask)return e.failure(new Error("实例状态不正确，有其他任务正在运行中"));try{e.setLock(!0);let t=e.config.updateCommand;t=t.replace(/\$\{mcsm_workspace\}/gm,e.config.cwd),o.default.info(`实例 ${e.instanceUuid} 正在准备进行更新操作...`),o.default.info(`实例 ${e.instanceUuid} 执行更新命令如下:`),o.default.info(t);const n=u.commandStringToArray(t),s=n[0],r=n.slice(1);if(0===n.length)return e.failure(new Error("更新命令格式错误，请联系管理员"));const c=i.spawn(s,r,{cwd:e.config.cwd,stdio:"pipe",windowsHide:!0});if(!c||!c.pid)return this.stoped(e),e.println("错误","更新失败，更新命令启动失败，请联系管理员");this.pid=c.pid,this.process=c,e.asynchronousTask=this,e.status(a.default.STATUS_BUSY),c.stdout.on("data",(t=>{e.print(l.default.decode(t,e.config.oe))})),c.stderr.on("data",(t=>{e.print(l.default.decode(t,e.config.oe))})),c.on("exit",(t=>{this.stoped(e),0===t?e.println("更新","更新成功！"):e.println("更新","更新程序结束，但结果不正确，可能文件更新损坏或网络不畅通")}))}catch(t){this.stoped(e),e.println("更新",`更新错误: ${t}`)}}async stop(e){o.default.info(`用户请求终止实例 ${e.instanceUuid} 的 update 异步任务`),e.println("更新",`用户请求终止实例 ${e.instanceUuid} 的 update 异步任务`),e.println("更新","正在强制杀死任务进程..."),r.killProcess(this.pid,this.process)}}t.default=f},223:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(232));class i extends r.default{constructor(){super("KillCommand")}async exec(e){return e.config.eventTask&&e.config.eventTask.autoRestart&&(e.config.eventTask.ignore=!0),await e.execPreset("kill")}}t.default=i},3198:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(232));class i extends r.default{constructor(){super("NullCommand")}async exec(){}}t.default=i},8961:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(3691)),i=s(n(232));class o extends i.default{constructor(){super("ProcessInfo")}async exec(e){let t={cpu:0,memory:0,ppid:0,pid:0,ctime:0,elapsed:0,timestamp:0};return e.process&&e.process.pid&&(t=await r.default(e.process.pid)),t}}t.default=o},8378:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5275)),i=s(n(3018)),o=s(n(4470)),a=s(n(1017)),c=s(n(232)),u=s(n(1239)),l=n(2081),f=n(8127),d=n(5927),p=s(n(9659)),h=n(5018);class m extends Error{constructor(e){super(e)}}class g extends u.default{constructor(e){super(),this.process=e,this.pid=this.process.pid,e.stdout.on("data",(e=>this.emit("data",e))),e.stderr.on("data",(e=>this.emit("data",e))),e.on("exit",(e=>this.emit("exit",e)))}write(e){return this.process.stdin.write(e)}kill(e){return d.killProcess(this.pid,this.process,e)}async destroy(){try{if(this.process&&this.process.stdout&&this.process.stderr){for(const e of this.process.stdout.eventNames())this.process.stdout.removeAllListeners(e);for(const e of this.process.stderr.eventNames())this.process.stderr.removeAllListeners(e);for(const e of this.process.eventNames())this.process.removeAllListeners(e);this.process.stdout.destroy(),this.process.stderr.destroy()}}catch(e){}}}class _ extends c.default{constructor(){super("PtyStartCommand")}async exec(e,t="Unknown"){if(!(e.config.startCommand&&e.config.cwd&&e.config.ie&&e.config.oe))return e.failure(new m("启动命令，输入输出编码或工作目录为空值"));if(!o.default.existsSync(e.absoluteCwdPath()))return e.failure(new m("工作目录并不存在"));try{if(!o.default.existsSync(h.PTY_PATH))return i.default.info(`会话 ${t}: 请求开启实例，模式为 PTY 终端`),i.default.warn("PTY 终端转发程序不存在，自动降级到普通启动模式"),e.println("ERROR","仿真终端模式失败，可能是依赖程序不存在，正在自动降级到普通终端模式..."),e.config.terminalOption.pty=!1,await e.forceExec(new p.default),void await e.execPreset("start",t);e.setLock(!0),e.status(r.default.STATUS_STARTING),e.startCount++;const n=f.commandStringToArray(e.config.startCommand);if(0===n.length)return e.failure(new m("无法启动实例，启动命令为空"));const s=["-dir",e.config.cwd,"-cmd",JSON.stringify(n),"-size",`${e.config.terminalOption.ptyWindowCol},${e.config.terminalOption.ptyWindowRow}`,"-color"];i.default.info("----------------"),i.default.info(`会话 ${t}: 请求开启实例.`),i.default.info(`实例标识符: [${e.instanceUuid}]`),i.default.info(`启动命令: ${n.join(" ")}`),i.default.info(`PTY 路径: ${[h.PTY_PATH]}`),i.default.info(`PTY 参数: ${s.join(" ")}`),i.default.info(`工作目录: ${e.config.cwd}`),i.default.info("----------------");const c=l.spawn(h.PTY_PATH,s,{cwd:a.default.dirname(h.PTY_PATH),stdio:"pipe",windowsHide:!0});if(!c||!c.pid)throw e.println("ERROR",`检测到实例进程/容器启动失败（PID 为空），其可能的原因是：\n1. 实例启动命令编写错误，请前往实例设置界面检查启动命令与参数。\n2. 系统主机环境不正确或缺少环境，如 Java 环境等。\n\n原生启动命令：\n${e.config.startCommand}\n\n仿真终端中转命令:\n程序：${h.PTY_PATH}\n参数：${JSON.stringify(s)}\n\n请将此信息报告给管理员，技术人员或自行排查故障。\n如果您认为是面板仿真终端导致的问题，请在左侧终端设置中关闭“仿真终端”选项，我们将会采用原始输入输出流的方式监听程序。\n`),new m("实例启动失败，请检查启动命令，主机环境和配置文件等");const u=new g(c);e.started(u),i.default.info(`实例 ${e.instanceUuid} 成功启动 PID: ${process.pid}.`),e.println("INFO","全仿真终端模式已生效，您可以直接在终端内直接输入内容并使用 Ctrl，Tab 等功能键。")}catch(t){return e.instanceStatus=r.default.STATUS_STOP,e.releaseResources(),e.failure(t)}finally{e.setLock(!1)}}}t.default=_},7142:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5275)),i=s(n(232)),o=s(n(5202));class a extends i.default{constructor(){super("PtyStopCommand")}async exec(e){const t=e.config.stopCommand;if("^c"==t.toLocaleLowerCase())return e.failure(new Error("仿真终端无法使用Ctrl+C命令关闭进程，请重新设置关服命令"));if(e.status()===r.default.STATUS_STOP||!e.process)return e.failure(new Error("实例未处于运行中状态，无法进行停止"));e.status(r.default.STATUS_STOPPING),await e.exec(new o.default(t)),e.println("INFO",`已执行预设的关闭命令：${t}\n如果无法关闭实例请前往实例设置更改关闭实例的正确命令，比如 exit，stop，end 等`);const n=e.startCount;return setTimeout((()=>{e.status()===r.default.STATUS_STOPPING&&e.startCount===n&&(e.println("ERROR","关闭命令已发出但长时间未能关闭实例，可能是实例关闭命令错误或实例进程假死导致，现在将恢复到运行中状态，可使用强制终止指令结束进程。"),e.status(r.default.STATUS_RUNNING))}),6e5),e}}t.default=a},7765:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(232));class i extends r.default{constructor(){super("RestartCommand")}async exec(e){return e.config.eventTask&&e.config.eventTask.autoRestart&&(e.config.eventTask.ignore=!0),await e.execPreset("restart")}}t.default=i},1155:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5275)),i=s(n(232));class o extends Error{constructor(e){super(e)}}class a extends i.default{constructor(e="Unknown"){super("StartCommand"),this.source=e}async exec(e){if(e.status()!==r.default.STATUS_STOP)return e.failure(new o("实例未处于关闭状态，无法再进行启动"));const t=new Date(e.config.endTime).getTime();if(t&&t<=(new Date).getTime())return e.failure(new Error("实例使用到期时间已到，无法再启动实例"));const n=(new Date).getTime();if(e.startTimestamp&&n-e.startTimestamp<1e4){const t=Number((1e4-(n-e.startTimestamp))/1e3).toFixed(0);return e.failure(new Error(`两次启动间隔太短，本次请求被拒绝，请 ${t} 秒后再试`))}return e.startTimestamp=n,await e.execPreset("start",this.source)}}t.default=a},3777:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(232));class i extends r.default{constructor(){super("StopCommand")}async exec(e){return e.config.eventTask&&e.config.eventTask.autoRestart&&(e.config.eventTask.ignore=!0),await e.execPreset("stop")}}t.default=i},699:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.name="RefreshPlayer",this.status=0,this.task=null,this.playersChartTask=null,this.playersChart=[]}async start(e){this.task=setInterval((async()=>{try{const t=await e.execPreset("getPlayer");if(!t)return;e.info.maxPlayers=t.max_players?t.max_players:-1,e.info.currentPlayers=t.current_players?t.current_players:-1,e.info.version=t.version?t.version:"",0===this.playersChart.length&&this.initPlayersChart(e)}catch(e){}}),3e3),this.playersChartTask=setInterval((()=>{this.getPlayersChartData(e)}),6e5)}initPlayersChart(e){for(;this.playersChart.length<60;)this.playersChart.push({value:"0"});e.info.playersChart=this.playersChart,this.getPlayersChartData(e)}getPlayersChartData(e){var t;try{this.playersChart.shift(),this.playersChart.push({value:null!==(t=String(e.info.currentPlayers))&&void 0!==t?t:"0"}),e.info.playersChart=this.playersChart}catch(e){}}async stop(e){clearInterval(this.task),clearInterval(this.playersChartTask),e.info.maxPlayers=-1,e.info.currentPlayers=-1,e.info.version="",e.info.playersChart=[],this.playersChart=[],this.playersChartTask=null,this.task=null}}},1819:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(223));t.default=class{constructor(){this.status=0,this.name="TimeCheck",this.task=null}async start(e){this.task=setInterval((async()=>{const t=new Date(e.config.endTime).getTime();t&&t<=(new Date).getTime()&&(await e.exec(new r.default),clearInterval(this.task))}),36e5)}async stop(e){clearInterval(this.task)}}},8222:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.globalEnv=t.Config=t.globalConfiguration=void 0;const r=n(5828),i=s(n(2270));class o{constructor(){this.version=2,this.ip="",this.port=24444,this.key=function(){const e=`${r.v4().replace(/\-/gim,"")}`;return e.slice(0,e.length/2-1)+`${r.v4().replace(/\-/gim,"")}`}(),this.maxFileTask=2,this.maxZipFileSize=60}}t.Config=o;class a{constructor(){this.config=new o}load(){let e=i.default.load("Config",o,a.ID);null==e&&(e=new o,i.default.store("Config",a.ID,e)),this.config=e}store(){i.default.store("Config",a.ID,this.config)}}a.ID="global";const c=new a;t.globalConfiguration=c;const u=new class{constructor(){this.fileTaskCount=0}};t.globalEnv=u},2827:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t,n,s){this.uuid=e,this.socket=t,this.session=n,this.event=s}response(e){return this}}},8485:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5275));t.default=class{constructor(){this.nickname="Undefined",this.startCommand="",this.stopCommand="^C",this.cwd=".",this.ie="utf-8",this.oe="utf-8",this.createDatetime=(new Date).toLocaleDateString(),this.lastDatetime="--",this.type=r.default.TYPE_UNIVERSAL,this.tag=[],this.endTime="",this.fileCode="utf-8",this.processType="general",this.updateCommand="",this.crlf=1,this.actionCommandList=[],this.terminalOption={haveColor:!1,pty:!0,ptyWindowCol:140,ptyWindowRow:40},this.eventTask={autoStart:!1,autoRestart:!1,ignore:!1},this.docker={containerName:"",image:"",ports:[],extraVolumes:[],memory:null,networkMode:"bridge",networkAliases:[],cpusetCpus:"",cpuUsage:null,maxSpace:null,io:null,network:null},this.pingConfig={ip:"",port:25565,type:1}}}},5275:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(5135)),i=s(n(1017)),o=s(n(4470)),a=n(1239),c=s(n(2270)),u=n(513),l=n(6415),f=s(n(9659)),d=s(n(1155)),p=n(4397),h=n(5018);class m extends a.EventEmitter{constructor(e,t){if(super(),this.startTimestamp=0,this.asynchronousTask=null,this.lifeCycleTaskManager=new u.LifeCycleTaskManager(this),this.presetCommandManager=new l.PresetCommandManager(this),this.info={currentPlayers:-1,maxPlayers:-1,version:"",fileLock:0,playersChart:[]},!e||!t)throw new Error("初始化实例失败，唯一标识符或配置参数为空");this.instanceStatus=m.STATUS_STOP,this.instanceUuid=e,this.lock=!1,this.config=t,this.process=null,this.startCount=0}parameters(e){var t,n,s;if((null==e?void 0:e.type)&&(null==e?void 0:e.type)!=this.config.type){if(this.status()!=m.STATUS_STOP)throw new Error("正在运行时无法修改此实例类型");p.configureEntityParams(this.config,e,"type",String),this.forceExec(new f.default)}if((null==e?void 0:e.processType)&&(null==e?void 0:e.processType)!==this.config.processType){if(this.status()!=m.STATUS_STOP)throw new Error("正在运行时无法修改此实例进程类型");p.configureEntityParams(this.config,e,"processType",String),this.forceExec(new f.default)}if(null!=(null===(t=null==e?void 0:e.terminalOption)||void 0===t?void 0:t.pty)&&(null===(n=null==e?void 0:e.terminalOption)||void 0===n?void 0:n.pty)!==this.config.terminalOption.pty){if(this.status()!=m.STATUS_STOP)throw new Error("正在运行时无法修改PTY模式");if(!o.default.existsSync(h.PTY_PATH)&&!0===(null===(s=null==e?void 0:e.terminalOption)||void 0===s?void 0:s.pty))throw new Error(`无法启用仿真终端，因为 ${h.PTY_PATH} 附属程序不存在，您可以联系管理员重启 Daemon 程序得以重新安装（仅 Linux）`);p.configureEntityParams(this.config.terminalOption,e.terminalOption,"pty",Boolean),this.forceExec(new f.default)}this.status()===m.STATUS_STOP&&e.terminalOption&&(p.configureEntityParams(this.config.terminalOption,e.terminalOption,"ptyWindowCol",Number),p.configureEntityParams(this.config.terminalOption,e.terminalOption,"ptyWindowRow",Number)),p.configureEntityParams(this.config,e,"nickname",String),p.configureEntityParams(this.config,e,"startCommand",String),p.configureEntityParams(this.config,e,"stopCommand",String),p.configureEntityParams(this.config,e,"cwd",String),p.configureEntityParams(this.config,e,"ie",String),p.configureEntityParams(this.config,e,"oe",String),p.configureEntityParams(this.config,e,"crlf",Number),p.configureEntityParams(this.config,e,"endTime",String),p.configureEntityParams(this.config,e,"fileCode",String),p.configureEntityParams(this.config,e,"updateCommand",String),e.docker&&(p.configureEntityParams(this.config.docker,e.docker,"containerName",String),p.configureEntityParams(this.config.docker,e.docker,"image",String),p.configureEntityParams(this.config.docker,e.docker,"memory",Number),p.configureEntityParams(this.config.docker,e.docker,"ports"),p.configureEntityParams(this.config.docker,e.docker,"extraVolumes"),p.configureEntityParams(this.config.docker,e.docker,"maxSpace",Number),p.configureEntityParams(this.config.docker,e.docker,"io",Number),p.configureEntityParams(this.config.docker,e.docker,"network",Number),p.configureEntityParams(this.config.docker,e.docker,"networkMode",String),p.configureEntityParams(this.config.docker,e.docker,"networkAliases"),p.configureEntityParams(this.config.docker,e.docker,"cpusetCpus",String),p.configureEntityParams(this.config.docker,e.docker,"cpuUsage",Number)),e.pingConfig&&(p.configureEntityParams(this.config.pingConfig,e.pingConfig,"ip",String),p.configureEntityParams(this.config.pingConfig,e.pingConfig,"port",Number),p.configureEntityParams(this.config.pingConfig,e.pingConfig,"type",Number)),e.eventTask&&(p.configureEntityParams(this.config.eventTask,e.eventTask,"autoStart",Boolean),p.configureEntityParams(this.config.eventTask,e.eventTask,"autoRestart",Boolean),p.configureEntityParams(this.config.eventTask,e.eventTask,"ignore",Boolean)),e.terminalOption&&p.configureEntityParams(this.config.terminalOption,e.terminalOption,"haveColor",Boolean),c.default.store("InstanceConfig",this.instanceUuid,this.config)}setLock(e){this.lock=e}async execCommand(e){if(this.lock)throw new Error(`此 ${e.info} 操作无法执行，因为实例处于锁定状态，请稍后再试.`);if(this.status()==m.STATUS_BUSY)throw new Error("当前实例正处于忙碌状态，无法执行任何操作.");return await e.exec(this)}async exec(e){return await this.execCommand(e)}async forceExec(e){return await e.exec(this)}status(e){return null!=e&&(this.instanceStatus=e),this.instanceStatus}started(e){this.config.lastDatetime=this.fullTime(),e.on("data",(e=>this.emit("data",r.default.decode(e,this.config.oe)))),e.on("exit",(e=>this.stoped(e))),this.process=e,this.instanceStatus=m.STATUS_RUNNING,this.emit("open",this),this.lifeCycleTaskManager.execLifeCycleTask(1)}failure(e){throw this.emit("failure",e),this.println("错误",e.message),e}stoped(e=0){this.releaseResources(),this.instanceStatus!=m.STATUS_STOP&&(this.instanceStatus=m.STATUS_STOP,this.emit("exit",e),c.default.store("InstanceConfig",this.instanceUuid,this.config)),this.lifeCycleTaskManager.execLifeCycleTask(0),this.config.eventTask.autoRestart&&(this.config.eventTask.ignore||this.forceExec(new d.default("Event Task: Auto Restart")).then((()=>{this.println("信息","检测到实例关闭，根据主动事件机制，自动重启指令已发出...")})).catch((e=>{this.println("错误",`自动重启错误: ${e}`)})),this.config.eventTask.ignore=!1),(new Date).getTime()-this.startTimestamp<3e3&&this.println("ERROR","检测到实例启动后在极短的时间内退出，原因可能是您的启动命令错误或配置文件错误。")}println(e,t){const n=`\n[MCSMANAGER] [${e}] ${t}\n`;this.emit("data",n)}print(e){this.emit("data",e)}releaseResources(){this.process=null}destroy(){this.process&&this.process.pid&&this.process.kill("SIGKILL"),this.process=null}fullTime(){const e=new Date;return e.toLocaleDateString()+" "+e.getHours()+":"+e.getMinutes()}absoluteCwdPath(){return this.config&&this.config.cwd?i.default.isAbsolute(this.config.cwd)?i.default.normalize(this.config.cwd):i.default.normalize(i.default.join(process.cwd(),this.config.cwd)):null}async usedSpace(e,t=4,n=0){return 0}async execPreset(e,t){if(this.presetCommandManager)return await this.presetCommandManager.execPreset(e,t);throw new Error("Preset Manager does not exist")}setPreset(e,t){this.presetCommandManager.setPreset(e,t)}getPreset(e){return this.presetCommandManager.getPreset(e)}clearPreset(){this.presetCommandManager.clearPreset()}}t.default=m,m.STATUS_BUSY=-1,m.STATUS_STOP=0,m.STATUS_STOPPING=1,m.STATUS_STARTING=2,m.STATUS_RUNNING=3,m.TYPE_UNIVERSAL="universal",m.TYPE_MINECRAFT_JAVA="minecraft/java",m.TYPE_MINECRAFT_BEDROCK="minecraft/bedrock"},513:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LifeCycleTaskManager=void 0,t.LifeCycleTaskManager=class{constructor(e){this.self=e,this.lifeCycleTask=[]}registerLifeCycleTask(e){this.lifeCycleTask.push(e)}execLifeCycleTask(e){1==e?this.lifeCycleTask.forEach((e=>{0===e.status&&e.start(this.self),e.status=1})):this.lifeCycleTask.forEach((e=>{1===e.status&&e.stop(this.self),e.status=0}))}clearLifeCycleTask(){this.execLifeCycleTask(0),this.lifeCycleTask.splice(0,this.lifeCycleTask.length)}}},6415:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PresetCommandManager=void 0,t.PresetCommandManager=class{constructor(e){this.self=e,this.preset=new Map}setPreset(e,t){this.preset.set(e,t)}getPreset(e){return this.preset.get(e)}async execPreset(e,t){const n=this.preset.get(e);if(!n)throw new Error(`预设命令 ${e} 不可用`);return await n.exec(this.self,t)}clearPreset(){this.preset.clear()}}},3611:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProcessConfig=void 0;const r=s(n(9066)),i=s(n(8231)),o=s(n(1017)),a=s(n(4470)),c="utf-8";t.ProcessConfig=class{constructor(e){this.iProcessConfig=e,e.path=o.default.normalize(e.path)}read(){const e=a.default.readFileSync(this.iProcessConfig.path,{encoding:c});return"yml"===this.iProcessConfig.type?r.default.parse(e):"properties"===this.iProcessConfig.type?i.default.parse(e):"json"===this.iProcessConfig.type?JSON.parse(e):"txt"===this.iProcessConfig.type?e:void 0}write(e){let t="";if("yml"===this.iProcessConfig.type&&(t=r.default.stringify(e)),"properties"===this.iProcessConfig.type&&(t=i.default.stringify(e),t=t.replace(/ = /gim,"="),"server.properties"==this.iProcessConfig.fileName&&(t=t.replace(/\\\\u/gim,"\\u"))),"json"===this.iProcessConfig.type&&(t=JSON.stringify(e)),"txt"===this.iProcessConfig.type&&(t=e.toString()),!t)throw new Error("写入内容为空，可能是配置文件类型不支持");a.default.writeFileSync(this.iProcessConfig.path,t,{encoding:c})}exists(){return a.default.existsSync(this.iProcessConfig.path)}}},156:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(232)),i=s(n(1787));class o extends r.default{constructor(){super("MinecraftGetPlayersCommand")}async exec(e){return e.config.pingConfig.ip&&e.config.pingConfig.port?await new i.default(e.config.pingConfig.port,e.config.pingConfig.ip).getStatus():null}}t.default=o},3088:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1891),i=s(n(232));class o extends i.default{constructor(){super("MinecraftBedrockGetPlayersCommand")}async exec(e){if(e.config.pingConfig.ip&&e.config.pingConfig.port){const t=await async function(e,t){const n=Buffer.from("01 00 00 00 00 00 06 18 20 00 FF FF 00 FE FE FE FE FD FD FD FD 12 34 56 78 A3 61 1C F8 BA 8F D5 60".replace(/ /g,""),"hex"),s=r.createSocket("udp4");var i={ip:e,port:t};return new Promise(((e,t)=>{s.on("error",(e=>{try{s.close()}catch(e){}t(e)})),s.on("message",(t=>{const n=t.toString().split(";");e(n),s.close()})),s.send(n,i.port,i.ip,(e=>{e&&(t(e),s.close())})),setTimeout((()=>{t("request timeout");try{s.close()}catch(e){}}),5e3)}))}(e.config.pingConfig.ip,e.config.pingConfig.port);return{version:t[3],motd:t[0],current_players:t[4],max_players:t[5]}}return null}}t.default=o},390:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(n(4470)),c=i(n(8742)),u=n(1018),l=o(n(9597)),f=o(n(3018)),d=o(n(1017)),p=o(n(1155)),h=o(n(3777)),m=o(n(5202)),g=o(n(223)),_=o(n(8961)),y=o(n(7701)),w=n(3611),k=o(n(7765));u.routerApp.use(((e,t,n,s)=>{if("instance/new"==e&&n)return s();if("instance/overview"==e)return s();if("instance/select"==e)return s();if(e.startsWith("instance")){if(n.instanceUuids)return s();const r=n.instanceUuid;if(!l.default.exists(r))return c.error(t,e,{instanceUuid:r,err:`The operation failed, the instance ${r} does not exist.`})}s()})),u.routerApp.on("instance/select",((e,t)=>{const n=t.page||1,s=t.pageSize||1,r=t.condition,i=[],o=l.default.getQueryMapWrapper();let a=o.select((e=>!!e.config.nickname.includes(r.instanceName)));const u=o.page(a,n,s);u.data.forEach((e=>{i.push({instanceUuid:e.instanceUuid,started:e.startCount,status:e.status(),config:e.config,info:e.info})})),i.sort(((e,t)=>e.config.nickname>=t.config.nickname?1:-1)),c.response(e,{page:u.page,pageSize:u.pageSize,maxPage:u.maxPage,data:i})})),u.routerApp.on("instance/overview",(e=>{const t=[];l.default.instances.forEach((e=>{t.push({instanceUuid:e.instanceUuid,started:e.startCount,status:e.status(),config:e.config,info:e.info})})),c.msg(e,"instance/overview",t)})),u.routerApp.on("instance/section",((e,t)=>{const n=t.instanceUuids,s=[];l.default.instances.forEach((e=>{n.forEach((t=>{t===e.instanceUuid&&s.push({instanceUuid:e.instanceUuid,started:e.startCount,status:e.status(),config:e.config,info:e.info})}))})),c.msg(e,"instance/section",s)})),u.routerApp.on("instance/detail",(async(e,t)=>{try{const n=t.instanceUuid,s=l.default.getInstance(n);let r=null,i=null;try{r=await s.forceExec(new _.default),i=await s.usedSpace(null,2)}catch(e){}c.msg(e,"instance/detail",{instanceUuid:s.instanceUuid,started:s.startCount,status:s.status(),config:s.config,info:s.info,space:i,processInfo:r})}catch(t){c.error(e,"instance/detail",{err:t.message})}})),u.routerApp.on("instance/new",((e,t)=>{const n=t;try{const t=l.default.createInstance(n);c.msg(e,"instance/new",{instanceUuid:t.instanceUuid,config:t.config})}catch(t){c.error(e,"instance/new",{instanceUuid:null,err:t.message})}})),u.routerApp.on("instance/update",((e,t)=>{const n=t.instanceUuid,s=t.config;try{l.default.getInstance(n).parameters(s),c.msg(e,"instance/update",{instanceUuid:n})}catch(t){c.error(e,"instance/update",{instanceUuid:n,err:t.message})}})),u.routerApp.on("instance/forward",((e,t)=>{const n=t.instanceUuid,s=t.forward;try{s?(f.default.info(`会话 ${e.socket.id} 请求转发实例 ${n} IO 流`),l.default.forward(n,e.socket)):(f.default.info(`会话 ${e.socket.id} 请求取消转发实例 ${n} IO 流`),l.default.stopForward(n,e.socket)),c.msg(e,"instance/forward",{instanceUuid:n})}catch(t){c.error(e,"instance/forward",{instanceUuid:n,err:t.message})}})),u.routerApp.on("instance/open",(async(e,t)=>{const n=t.disableResponse;for(const s of t.instanceUuids){const t=l.default.getInstance(s);try{await t.exec(new p.default(e.socket.id)),n||c.msg(e,"instance/open",{instanceUuid:s})}catch(t){n||(f.default.error(`实例${s}启动时错误: `,t),c.error(e,"instance/open",{instanceUuid:s,err:t.message}))}}})),u.routerApp.on("instance/stop",(async(e,t)=>{const n=t.disableResponse;for(const s of t.instanceUuids){const t=l.default.getInstance(s);try{await t.exec(new h.default),n||c.msg(e,"instance/stop",{instanceUuid:s})}catch(t){n||c.error(e,"instance/stop",{instanceUuid:s,err:t.message})}}})),u.routerApp.on("instance/restart",(async(e,t)=>{const n=t.disableResponse;for(const s of t.instanceUuids){const t=l.default.getInstance(s);try{await t.exec(new k.default),n||c.msg(e,"instance/restart",{instanceUuid:s})}catch(t){n||c.error(e,"instance/restart",{instanceUuid:s,err:t.message})}}})),u.routerApp.on("instance/kill",(async(e,t)=>{const n=t.disableResponse;for(const s of t.instanceUuids){const t=l.default.getInstance(s);if(t)try{await t.forceExec(new g.default),n||c.msg(e,"instance/kill",{instanceUuid:s})}catch(t){n||c.error(e,"instance/kill",{instanceUuid:s,err:t.message})}}})),u.routerApp.on("instance/command",(async(e,t)=>{const n=t.disableResponse,s=t.instanceUuid,r=t.command||"",i=l.default.getInstance(s);try{await i.exec(new m.default(r)),n||c.msg(e,"instance/command",{instanceUuid:s})}catch(t){n||c.error(e,"instance/command",{instanceUuid:s,err:t.message})}})),u.routerApp.on("instance/delete",((e,t)=>{const n=t.instanceUuids,s=t.deleteFile;for(const e of n)try{l.default.removeInstance(e,s)}catch(e){}c.msg(e,"instance/delete",n)})),u.routerApp.on("instance/asynchronous",((e,t)=>{const n=t.instanceUuid,s=t.taskName,r=t.parameter,i=l.default.getInstance(n);f.default.info(`会话 ${e.socket.id} 要求实例 ${i.instanceUuid} 执行异步 ${s} 异步任务`),"update"===s&&i.execPreset("update",r).then((()=>{})).catch((e=>{f.default.error(`实例 ${i.instanceUuid} ${s} 异步任务执行异常: ${e}`)})),c.msg(e,"instance/asynchronous",!0)})),u.routerApp.on("instance/stop_asynchronous",((e,t)=>{const n=t.instanceUuid,s=l.default.getInstance(n),r=s.asynchronousTask;if(!r||!r.stop)return c.error(e,"instance/stop_asynchronous","无任务异步任务正在运行");r.stop(s).then((()=>{})).catch((e=>{})),c.msg(e,"instance/stop_asynchronous",!0)})),u.routerApp.on("instance/stdin",((e,t)=>{const n=l.default.getInstance(t.instanceUuid);try{if("\r"==t.ch)return n.process.write("\n");n.process.write(t.ch)}catch(e){}})),u.routerApp.on("instance/process_config/list",((e,t)=>{const n=t.instanceUuid,s=t.files,r=[];try{const t=l.default.getInstance(n),i=new y.default(t.absoluteCwdPath());for(const e of s)i.check(e)&&r.push({file:e,check:!0});c.response(e,r)}catch(t){c.responseError(e,t)}})),u.routerApp.on("instance/process_config/file",((e,t)=>{const n=t.instanceUuid,s=t.fileName,r=t.config||null,i=t.type;try{const t=l.default.getInstance(n);if(!new y.default(t.absoluteCwdPath()).check(s))throw new Error("文件不存在或路径错误，文件访问被拒绝");const o=d.default.normalize(d.default.join(t.absoluteCwdPath(),s)),a=new w.ProcessConfig({fileName:s,redirect:s,path:o,type:i,info:null,fromLink:null});if(r)return a.write(r),c.response(e,!0);{const t=a.read();return c.response(e,t)}}catch(t){c.responseError(e,t)}})),u.routerApp.on("instance/outputlog",(async(e,t)=>{const n=t.instanceUuid;try{const t=d.default.join(l.default.LOG_DIR,`${n}.log`);if(a.default.existsSync(t)){const n=await a.default.readFile(t,{encoding:"utf-8"});return c.response(e,n)}c.responseError(e,new Error("终端日志文件不存在"),{notPrintErr:!0})}catch(t){c.responseError(e,t)}}))},7098:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1018),c=i(n(8742)),u=n(8222),l=o(n(3018)),f="TOP_LEVEL";a.routerApp.use((async(e,t,n,s)=>{const r=t.socket;if(e.startsWith("stream"))return s();if("auth"===e)return await s();if(!t.session)throw new Error("Session does not exist in authentication middleware.");return t.session.key===u.globalConfiguration.config.key&&t.session.type===f&&t.session.login&&t.session.id?await s():(l.default.warn(`会话 ${r.id}(${r.handshake.address}) 试图无权限访问 ${e} 现已阻止.`),c.error(t,"error","权限不足，非法访问"))})),a.routerApp.on("auth",((e,t)=>{t===u.globalConfiguration.config.key?(l.default.info(`会话 ${e.socket.id}(${e.socket.handshake.address}) 验证身份成功`),function(e,t){e.session.key=t,e.session.login=!0,e.session.id=e.socket.id,e.session.type=f,e.session}(e,t),c.msg(e,"auth",!0)):c.msg(e,"auth",!1)})),a.routerApp.on("connection",(e=>{const t=e.session;setTimeout((()=>{t.login||(e.socket.disconnect(),l.default.info(`会话 ${e.socket.id}(${e.socket.handshake.address}) 因长时间未验证身份而断开连接`))}),6e3)}))},7232:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(3576),c=i(n(8742)),u=n(1018),l=i(n(4470)),f=o(n(1017)),d=n(5828),p=o(n(3018));u.routerApp.on("environment/images",(async(e,t)=>{try{const t=(new a.DockerManager).getDocker(),n=await t.listImages();c.response(e,n)}catch(t){c.responseError(e,"无法获取镜像信息，请确保您已正确安装Docker环境")}})),u.routerApp.on("environment/containers",(async(e,t)=>{try{const t=(new a.DockerManager).getDocker(),n=await t.listContainers();c.response(e,n)}catch(t){c.responseError(e,t)}})),u.routerApp.on("environment/networkModes",(async(e,t)=>{try{const t=(new a.DockerManager).getDocker(),n=await t.listNetworks();c.response(e,n)}catch(t){c.responseError(e,t)}})),u.routerApp.on("environment/new_image",(async(e,t)=>{try{const n=t.dockerFile,s=t.name,r=t.tag,i=d.v4(),o=f.default.normalize(f.default.join(process.cwd(),"tmp",i));l.existsSync(o)||l.mkdirsSync(o);const u=f.default.normalize(f.default.join(o,"Dockerfile"));await l.writeFile(u,n,{encoding:"utf-8"}),p.default.info(`守护进程正在创建镜像 ${s}:${r} DockerFile 如下:\n${n}\n`),c.response(e,!0);const h=`${s}:${r}`;try{await(new a.DockerManager).startBuildImage(o,h),p.default.info(`创建镜像 ${s}:${r} 完毕`)}catch(e){p.default.info(`创建镜像 ${s}:${r} 错误:${e}`)}}catch(t){c.responseError(e,t)}})),u.routerApp.on("environment/del_image",(async(e,t)=>{try{const n=t.imageId,s=(new a.DockerManager).getDocker().getImage(n);if(!s)throw new Error("Image does not exist");p.default.info(`守护进程正在删除镜像 ${n}`),await s.remove(),c.response(e,!0)}catch(t){c.responseError(e,t)}})),u.routerApp.on("environment/progress",(async e=>{try{const t={};a.DockerManager.builerProgress.forEach(((e,n)=>{t[n]=e})),c.response(e,t)}catch(t){c.responseError(e,t)}}))},2384:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(8742)),c=n(1018),u=o(n(9597)),l=n(5925),f=n(8222);c.routerApp.use(((e,t,n,s)=>{if(e.startsWith("file/")){const s=n.instanceUuid;if(!u.default.exists(s))return a.error(t,e,{instanceUuid:s,err:`实例 ${s} 不存在`})}s()})),c.routerApp.on("file/list",((e,t)=>{try{const n=l.getFileManager(t.instanceUuid),{page:s,pageSize:r,target:i}=t;n.cd(i);const o=n.list(s,r);a.response(e,o)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/status",((e,t)=>{var n,s;try{const r=u.default.getInstance(t.instanceUuid);a.response(e,{instanceFileTask:null!==(n=r.info.fileLock)&&void 0!==n?n:0,globalFileTask:null!==(s=f.globalEnv.fileTaskCount)&&void 0!==s?s:0})}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/mkdir",((e,t)=>{try{const n=t.target;l.getFileManager(t.instanceUuid).mkdir(n),a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/copy",(async(e,t)=>{try{const n=t.targets,s=l.getFileManager(t.instanceUuid);for(const e of n)s.copy(e[0],e[1]);a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/move",(async(e,t)=>{try{const n=t.targets,s=l.getFileManager(t.instanceUuid);for(const e of n)await s.move(e[0],e[1]);a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/delete",(async(e,t)=>{try{const n=t.targets,s=l.getFileManager(t.instanceUuid);for(const e of n)s.delete(e);a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/edit",(async(e,t)=>{try{const n=t.target,s=t.text,r=l.getFileManager(t.instanceUuid),i=await r.edit(n,s);a.response(e,i||!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/compress",(async(e,t)=>{const n=f.globalConfiguration.config.maxFileTask;try{const s=t.source,r=t.targets,i=t.type,o=t.code,c=l.getFileManager(t.instanceUuid),d=u.default.getInstance(t.instanceUuid);if(d.info.fileLock>=n)throw new Error(`超出最大同时解压缩任务量，最大准许${n}个，目前有${d.info.fileLock}个任务正在进行，请耐心等待`);function p(){d.info.fileLock++,f.globalEnv.fileTaskCount++}function h(){d.info.fileLock--,f.globalEnv.fileTaskCount--}p();try{1===i?c.zip(s,r,o):c.unzip(s,r,o),a.response(e,!0)}catch(m){throw m}finally{h()}}catch(g){a.responseError(e,g)}}))},1697:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1511)),i=s(n(4470)),o=s(n(1017)),a=n(5496),c=s(n(9597)),u=s(n(7701)),l=new r.default;l.all("/",(async e=>{e.body="[MCSManager Daemon] Status: online | reference: https://docs.mcsmanager.com/",e.status=200})),l.get("/download/:key/:fileName",(async e=>{const t=e.params.key,n=e.params.fileName;try{const s=a.missionPassport.getMission(t,"download");if(!s)throw new Error(e.body="No task, Access denied | 无下载任务，非法访问");const r=c.default.getInstance(s.parameter.instanceUuid);if(!r)throw new Error("实例不存在");if(!u.default.checkFileName(n))throw new Error("用户文件下载名不符合规范");const l=r.config.cwd,f=s.parameter.fileName,d=o.default.extname(f),p=new u.default(l);if(!p.check(f))throw new Error(e.body="Access denied | 参数不正确");e.response.set("Content-Disposition",`attachment; filename="${encodeURIComponent(n)}"`),e.type=d,e.body=i.default.createReadStream(p.toAbsolutePath(f)),a.missionPassport.deleteMission(t)}catch(t){e.body=`下载出错: ${t.message}`,e.status=500}finally{a.missionPassport.deleteMission(t)}})),l.post("/upload/:key",(async e=>{const t=e.params.key,n=e.query.unzip,s=String(e.query.code);try{const r=a.missionPassport.getMission(t,"upload");if(!r)throw new Error("Access denied 0x061");const l=c.default.getInstance(r.parameter.instanceUuid);if(!l)throw new Error("Access denied 0x062");const f=r.parameter.uploadDir,d=l.config.cwd,p=e.request.files.file;if(p){const t=p.name,r=o.default.normalize(o.default.join(f,t));if(!u.default.checkFileName(t))throw new Error("Access denied 0x063");const a=new u.default(d);if(!a.checkPath(r))throw new Error("Access denied 0x064");const c=a.toAbsolutePath(r),h=i.default.createReadStream(p.path),m=i.default.createWriteStream(c);return h.pipe(m),h.on("close",(()=>{n&&new u.default(l.config.cwd).unzip(t,"",s)})),e.body="OK"}e.body="未知原因: 上传失败",e.status=500}catch(t){e.body=t.message,e.status=500}finally{a.missionPassport.deleteMission(t)}})),t.default=l},6194:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(8742)),c=n(1018),u=o(n(9597)),l=o(n(5275)),f=n(5103),d=n(4310);c.routerApp.on("info/overview",(async e=>{const t=d.getVersion();let n=0,s=0;u.default.instances.forEach((e=>{n++,e.status()==l.default.STATUS_RUNNING&&s++}));const r={version:t,process:{cpu:process.cpuUsage().system,memory:process.memoryUsage().heapUsed,cwd:process.cwd()},instance:{running:s,total:n},system:f.systemInfo()};a.response(e,r)}))},8709:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(n(1017)),c=o(n(2827)),u=i(n(8742)),l=o(n(9597)),f=o(n(4470)),d=new Map;setInterval((()=>{d.forEach(((e,t)=>{if(!e||!t)return;const n=a.default.join(l.default.LOG_DIR,`${t}.log`);f.default.existsSync(l.default.LOG_DIR)||f.default.mkdirsSync(l.default.LOG_DIR);try{const e=f.default.statSync(n);e&&e.size>524288&&f.default.removeSync(n)}catch(e){}f.default.writeFile(n,e,{encoding:"utf-8",flag:"a"},(()=>{d.set(t,"")}))}))}),500),l.default.on("data",((e,t)=>{l.default.forEachForward(e,(n=>{u.msg(new c.default(null,n),"instance/stdout",{instanceUuid:e,text:t})})),async function(e,t){var n;const s=(null!==(n=d.get(e))&&void 0!==n?n:"")+t;s.length>1048576&&d.set(e,""),d.set(e,null!=s?s:null)}(e,t).then((()=>{})).catch((()=>{}))})),l.default.on("exit",(e=>{l.default.forEachForward(e.instanceUuid,(t=>{u.msg(new c.default(null,t),"instance/stopped",{instanceUuid:e.instanceUuid,instanceName:e.instanceName})}))})),l.default.on("open",(e=>{l.default.forEachForward(e.instanceUuid,(t=>{u.msg(new c.default(null,t),"instance/opened",{instanceUuid:e.instanceUuid,instanceName:e.instanceName})}))})),l.default.on("failure",(e=>{l.default.forEachForward(e.instanceUuid,(t=>{u.msg(new c.default(null,t),"instance/failure",{instanceUuid:e.instanceUuid,instanceName:e.instanceName})}))}))},3360:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=n(1018),a=n(5496),c=i(n(8742));o.routerApp.on("passport/register",((e,t)=>{const n=t.name,s=t.password,r=t.parameter,i=t.count,o=(new Date).getTime(),u=o+36e5;if(!n||!s)throw new Error("不可定义任务名或密钥为空");a.missionPassport.registerMission(s,{name:n,parameter:r,count:i,start:o,end:u}),c.response(e,!0)}))},5995:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1018),c=i(n(8742)),u=o(n(9945));a.routerApp.on("schedule/register",((e,t)=>{try{u.default.registerScheduleJob(t),c.response(e,!0)}catch(t){c.responseError(e,t)}})),a.routerApp.on("schedule/list",((e,t)=>{c.response(e,u.default.listScheduleJob(t.instanceUuid))})),a.routerApp.on("schedule/delete",((e,t)=>{u.default.deleteScheduleTask(t.instanceUuid,t.name),c.response(e,!0)}))},7264:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(8742)),c=n(1018),u=n(5496),l=o(n(9597)),f=o(n(3018)),d=o(n(5202));c.routerApp.use((async(e,t,n,s)=>"stream/auth"===e?s():e.startsWith("stream")?t.session.stream&&!0===t.session.stream.check&&"STREAM"===t.session.type?await s():a.error(t,"error","[Unauthorized Access] 权限不足，非法访问"):await s())),c.routerApp.on("stream/auth",((e,t)=>{try{const n=t.password,s=u.missionPassport.getMission(n,"stream_channel");if(!s)throw new Error("任务不存在");const r=l.default.getInstance(s.parameter.instanceUuid);if(!r)throw new Error("实例不存在");f.default.info(`会话 ${e.socket.id} ${e.socket.handshake.address} 数据流通道身份验证成功`),e.session.id=e.socket.id,e.session.login=!0,e.session.type="STREAM",e.session.stream={check:!0,instanceUuid:r.instanceUuid},l.default.forward(r.instanceUuid,e.socket),f.default.info(`会话 ${e.socket.id} ${e.socket.handshake.address} 已与 ${r.instanceUuid} 建立数据通道`),e.socket.on("disconnect",(()=>{l.default.stopForward(r.instanceUuid,e.socket),f.default.info(`会话 ${e.socket.id} ${e.socket.handshake.address} 已与 ${r.instanceUuid} 断开数据通道`)})),a.response(e,!0)}catch(t){a.responseError(e,t,{notPrintErr:!0})}})),c.routerApp.on("stream/detail",(async e=>{try{const t=e.session.stream.instanceUuid,n=l.default.getInstance(t);a.response(e,{instanceUuid:n.instanceUuid,started:n.startCount,status:n.status(),config:n.config,info:n.info})}catch(t){a.responseError(e,t)}})),c.routerApp.on("stream/input",(async(e,t)=>{try{const n=t.command,s=e.session.stream.instanceUuid,r=l.default.getInstance(s);await r.exec(new d.default(n))}catch(e){}})),c.routerApp.on("stream/write",(async(e,t)=>{try{const n=t.input,s=e.session.stream.instanceUuid,r=l.default.getInstance(s);r.process&&r.process.write(n)}catch(e){}})),c.routerApp.on("stream/resize",(async(e,t)=>{try{const n=e.session.stream.instanceUuid,s=l.default.getInstance(n);"docker"===s.config.processType&&await s.execPreset("resize",t)}catch(e){}}))},3576:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DockerManager=void 0;const r=s(n(4856));class i{constructor(e){this.docker=null,this.docker=new r.default(e)}getDocker(){return this.docker}static setBuilerProgress(e,t){i.builerProgress.set(e,t)}static getBuilerProgress(e){return i.builerProgress.get(e)}async startBuildImage(e,t){try{i.setBuilerProgress(t,1);const n=await this.docker.buildImage({context:e,src:["Dockerfile"]},{t});await new Promise(((e,t)=>{this.docker.modem.followProgress(n,((n,s)=>n?t(n):e(s)))})),i.setBuilerProgress(t,2)}catch(e){i.setBuilerProgress(t,-1)}}}t.DockerManager=i,i.builerProgress=new Map},5925:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getFileManager=void 0;const r=s(n(9597)),i=s(n(7701));t.getFileManager=function(e){var t;const n=r.default.getInstance(e);if(!n)throw new Error(`实例 ${e} 不存在`);const s=null===(t=n.config)||void 0===t?void 0:t.fileCode,o=n.config.cwd;return new i.default(o,s)}},9815:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.initKoa=void 0;const r=s(n(1406)),i=s(n(5004)),o=s(n(1697));t.initKoa=function(){const e=new r.default;return e.use(i.default({multipart:!0,formidable:{maxFileSize:0xfa00000000}})),e.use((async(e,t)=>{await t(),e.response.set("Access-Control-Allow-Origin","*"),e.response.set("Access-Control-Allow-Methods","POST, GET, PUT, DELETE, OPTIONS"),e.response.set("Access-Control-Allow-Headers","Content-Type, Cookie, Accept-Encoding, User-Agent, Host, Referer, X-Requested-With, Accept, Accept-Language, Cache-Control, Connection"),e.response.set("X-Power-by","MCSManager")})),e.use(o.default.routes()).use(o.default.allowedMethods()),e}},559:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.initDependent=void 0;const r=s(n(2037)),i=s(n(4470)),o=s(n(5687)),a=s(n(1017)),c=s(n(3018)),u=a.default.normalize(a.default.join(process.cwd(),"lib","pty")),l=a.default.join(process.cwd(),"lib");t.initDependent=function(){if("linux"!==r.default.platform())return c.default.info("检测到系统不是 Linux 系统，自动跳过依赖库安装");const e=["https://mcsmanager.com/download/pty_linux","https://mcsmanager.oss-cn-guangzhou.aliyuncs.com/pty_linux"];!function t(n=0){var s;(s=e[n],new Promise(((e,t)=>{var n;if("x64"!==r.default.arch()&&(i.default.existsSync(u)||c.default.info("仿真终端只能支持 Windows/Linux x86_64 架构，已自动降级为普通终端"),e(-1)),i.default.existsSync(l)||i.default.mkdirsSync(l),i.default.existsSync(u)&&(null===(n=i.default.statSync(u))||void 0===n?void 0:n.size)>1024)return c.default.info("识别到可选依赖库安装，仿真终端功能已可用"),e(1);const a=i.default.createWriteStream(u);o.default.get(s,(n=>{if(200!==n.statusCode)return t(new Error("code!=200"));n.on("error",(e=>{i.default.existsSync(u)&&i.default.removeSync(u),t(e)})),a.on("finish",(()=>{a.close(),e(0)})).on("error",(e=>{t(e)})),n.pipe(a)}))}))).then((()=>{c.default.info("可选依赖程序已自动安装，仿真终端和部分高级功能已自动启用"),c.default.info("依赖程序参考：https://github.com/mcsmanager/pty"),i.default.chmod(u,511,(e=>{e&&c.default.warn(`修改文件 ${u} 权限失败，请手动设置其为 chmod 755 以上`)}))})).catch((s=>(i.default.remove(u,(()=>{})),n===e.length-1?(c.default.warn("安装可选依赖库失败，全仿真终端和部分可选功能将无法使用，不影响正常功能，将在下次启动时再尝试安装"),void c.default.warn(s)):t(n+1))))}(0)}},3018:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(n(4470)),c=i(n(8094)),u="logs/current.log";if(a.default.existsSync(u)){const e=new Date,t=`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()}_${e.getHours()}-${e.getMinutes()}-${e.getSeconds()}`;a.default.renameSync(u,`logs/${t}.log`)}c.configure({appenders:{out:{type:"stdout",layout:{type:"pattern",pattern:"[%d{MM/dd hh:mm:ss}] [%[%p%]] %m"}},app:{type:"file",filename:u,layout:{type:"pattern",pattern:"%d %p %m"}}},categories:{default:{appenders:["out","app"],level:"info"}}});const l=c.getLogger("default");t.default=l},5496:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.missionPassport=void 0;const n=new class{constructor(){this.missions=new Map,setInterval((()=>{const e=(new Date).getTime();this.missions.forEach(((t,n)=>{e>t.end&&this.missions.delete(n)}))}),1e3)}registerMission(e,t){if(this.missions.has(e))throw new Error("Duplicate primary key, failed to create task");this.missions.set(e,t)}getMission(e,t){if(!this.missions.has(e))return null;const n=this.missions.get(e);return n.name===t?n:null}deleteMission(e){this.missions.delete(e)}};t.missionPassport=n},8742:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.broadcast=t.socketObjects=t.delGlobalSocket=t.addGlobalSocket=t.stringify=t.parse=t.error=t.msg=t.responseError=t.response=t.Packet=void 0;const r=s(n(2827)),i=s(n(3018)),o=new Map;class a{constructor(e=null,t=200,n=null,s=null){this.uuid=e,this.status=t,this.event=n,this.data=s}}function c(e,t,n){const s=new a(e.uuid,200,t,n);e.socket.emit(t,s)}t.Packet=a,t.response=function(e,t){const n=new a(e.uuid,200,e.event,t);e.socket.emit(e.event,n)},t.responseError=function(e,t,n){let s="";s=t?t.toString():t;const r=new a(e.uuid,500,e.event,s);if(t.toString().includes("[Unauthorized Access]"))return e.socket.emit(e.event,r);(null==n?void 0:n.notPrintErr)||i.default.warn(`会话 ${e.socket.id}(${e.socket.handshake.address})/${e.event} 响应数据时异常:\n`,t),e.socket.emit(e.event,r)},t.msg=c,t.error=function(e,t,n){const s=new a(e.uuid,500,t,n);if(n.toString().includes("[Unauthorized Access]"))return e.socket.emit(e.event,s);i.default.warn(`会话 ${e.socket.id}(${e.socket.handshake.address})/${t} 响应数据时异常:\n`,n),e.socket.emit(t,s)},t.parse=function(e){if("object"==typeof e)return new a(e.uuid||null,e.status,e.event,e.data);const t=JSON.parse(e);return new a(null,t.status,t.event,t.data)},t.stringify=function(e){return JSON.stringify(e)},t.addGlobalSocket=function(e){o.set(e.id,e)},t.delGlobalSocket=function(e){o.delete(e.id)},t.socketObjects=function(){return o},t.broadcast=function(e,t){o.forEach((n=>{c(new r.default(null,n),e,t)}))}},1018:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.navigation=t.routerApp=void 0;const r=n(1239),i=s(n(3018)),o=s(n(2827)),a=n(8742);class c extends r.EventEmitter{constructor(){super(),this.middlewares=[]}emitRouter(e,t,n){try{super.emit(e,t,n)}catch(e){a.responseError(t,e)}return this}on(e,t){return super.on(e,t)}use(e){this.middlewares.push(e)}getMiddlewares(){return this.middlewares}}t.routerApp=new c,t.navigation=function(e){const n={};for(const s of t.routerApp.getMiddlewares())e.use(((t,r)=>{const a=t[1];if(!a)return i.default.info(`session ${e.id} request data protocol format is incorrect`);const c=new o.default(a.uuid,e,n);s(t[0],c,a.data,r)}));for(const s of t.routerApp.eventNames())e.on(s,(r=>{if(!r)return i.default.info(`session ${e.id} request data protocol format is incorrect`);const a=new o.default(r.uuid,e,n,s.toString());t.routerApp.emitRouter(s,a,r.data)}));const s=new o.default(null,e,n);t.routerApp.emitRouter("connection",s,null)},n(7098),n(3360),n(6194),n(390),n(8709),n(2384),n(7264),n(7232),n(5995),i.default.info("所有功能模块与权限防火墙已初始化完毕")},7701:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1017)),i=s(n(4470)),o=n(5046),a=s(n(2037)),c=s(n(5135)),u=n(8222),l="非法访问路径";t.default=class{constructor(e="",t){this.topPath=e,this.fileCode=t,this.cwd=".",r.default.isAbsolute(e)?this.topPath=r.default.normalize(e):this.topPath=r.default.normalize(r.default.join(process.cwd(),e)),t||("win32"===a.default.platform()?this.fileCode="gbk":this.fileCode="utf-8")}toAbsolutePath(e=""){return r.default.normalize(r.default.join(this.topPath,this.cwd,e))}checkPath(e){const t=this.toAbsolutePath(e),n=this.topPath;return 0===t.indexOf(n)}check(e){return this.checkPath(e)&&i.default.existsSync(this.toAbsolutePath(e))}cd(e){if(!this.check(e))throw new Error(l);this.cwd=r.default.normalize(r.default.join(this.cwd,e))}list(e,t=40){if(t>100||t<=0||e<0)throw new Error("Beyond the value limit");const n=i.default.readdirSync(this.toAbsolutePath()),s=n.length,r=e*t,o=r+t,a=[],c=[];n.forEach((e=>{try{const t=i.default.statSync(this.toAbsolutePath(e));t.isFile()?a.push({name:e,type:1,size:t.size,time:t.atime.toString()}):c.push({name:e,type:0,size:t.size,time:t.atime.toString()})}catch(e){}})),a.sort(((e,t)=>e.name>t.name?1:-1)),c.sort(((e,t)=>e.name>t.name?1:-1));let u=c.concat(a);return u=u.slice(r,o),{items:u,page:e,pageSize:t,total:s}}async readFile(e){if(!this.check(e))throw new Error(l);const t=this.toAbsolutePath(e),n=await i.default.readFile(t);return c.default.decode(n,this.fileCode)}async writeFile(e,t){if(!this.check(e))throw new Error(l);const n=this.toAbsolutePath(e),s=c.default.encode(t,this.fileCode);return await i.default.writeFile(n,s)}async copy(e,t){if(!this.checkPath(t)||!this.check(e))throw new Error(l);const n=this.toAbsolutePath(e);return t=this.toAbsolutePath(t),await i.default.copy(n,t)}mkdir(e){if(!this.checkPath(e))throw new Error(l);const t=this.toAbsolutePath(e);return i.default.mkdirSync(t)}async delete(e){if(!this.check(e))throw new Error(l);const t=this.toAbsolutePath(e);return new Promise(((e,n)=>{i.default.remove(t,(t=>{t?n(t):e(!0)}))}))}async move(e,t){if(!this.check(e))throw new Error(l);if(!this.checkPath(t))throw new Error(l);const n=this.toAbsolutePath(e);t=this.toAbsolutePath(t),await i.default.move(n,t)}zipFileCheck(e){const t=i.default.statSync(e),n=u.globalConfiguration.config.maxZipFileSize;if(t.size>1073741824*n)throw new Error(`文件解压缩只支持最大 ${n}GB 文件的解压缩，如需改变上限请前往 data/Config/global.json 文件`)}unzip(e,t,n){if(n||(n=this.fileCode),!this.check(e)||!this.checkPath(t))throw new Error(l);this.zipFileCheck(this.toAbsolutePath(e)),o.decompress(this.toAbsolutePath(e),this.toAbsolutePath(t),n).then((()=>{})).catch((()=>{}))}zip(e,t,n){var s;if(n||(n=this.fileCode),!this.checkPath(e))throw new Error(l);const r=u.globalConfiguration.config.maxZipFileSize,a=1073741824*r,c=this.toAbsolutePath(e),f=[];let d=0;for(const e of t)if(this.check(e)){f.push(this.toAbsolutePath(e));try{d+=null===(s=i.default.statSync(this.toAbsolutePath(e)))||void 0===s?void 0:s.size}catch(e){}}if(d>a)throw new Error(`文件解压缩只支持所有文件大小和 ${r}GB 的压缩，如需改变上限请前往 data/Config/global.json 文件`);o.compress(c,f,n).then((()=>{})).catch((()=>{}))}async edit(e,t){if(!this.check(e))throw new Error(l);if(t)return await this.writeFile(e,t);{const t=this.toAbsolutePath(e);if(i.default.statSync(t).size>4194304)throw new Error("超出最大文件编辑限制");return await this.readFile(e)}}rename(e,t){if(!this.check(e))throw new Error(l);if(!this.checkPath(t))throw new Error(l);const n=this.toAbsolutePath(e),s=this.toAbsolutePath(t);i.default.renameSync(n,s)}static checkFileName(e){const t=["/","\\","|","?","*",">","<",";",'"'];for(const n of t)if(e.includes(n))return!1;return!0}}},9597:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(4470)),i=s(n(1017)),o=s(n(5275)),a=s(n(1239)),c=s(n(223)),u=s(n(3018)),l=n(5828),f=s(n(2270)),d=s(n(8485)),p=s(n(2764)),h=n(3459),m=s(n(9659)),g=s(n(9945)),_=s(n(1155)),y=i.default.join(process.cwd(),"data/InstanceData");r.default.existsSync(y)||r.default.mkdirsSync(y);class w extends a.default{constructor(){super(),this.LOG_DIR="data/InstanceLog/",this.instances=new Map,this.instanceStream=new p.default}autoStart(){this.instances.forEach((e=>{e.config.eventTask.autoStart&&e.exec(new _.default).then((()=>{u.default.info(`实例 ${e.config.nickname} ${e.instanceUuid} 自动启动指令已发出`)})).catch((t=>{u.default.error(`实例 ${e.config.nickname} ${e.instanceUuid} 自动启动时错误: ${t}`)}))}))}loadInstances(){f.default.list("InstanceConfig").forEach((e=>{try{const t=f.default.load("InstanceConfig",d.default,e),n=new o.default(e,t);n.forceExec(new m.default).then((e=>{})).catch((e=>{})),this.addInstance(n)}catch(t){u.default.error(`读取 ${e} 应用实例失败: ${t.message}`),u.default.error(`请检查或删除文件：data/InstanceConfig/${e}.json`)}})),this.autoStart()}createInstance(e){const t=l.v4().replace(/-/gim,""),n=new o.default(t,new d.default);return e.cwd&&"."!==e.cwd||(e.cwd=i.default.normalize(`${y}/${n.instanceUuid}`),r.default.existsSync(e.cwd)||r.default.mkdirsSync(e.cwd)),e.ie=e.oe=e.fileCode="utf8",n.parameters(e),n.forceExec(new m.default),this.addInstance(n),n}addInstance(e){if(null==e.instanceUuid)throw new Error("无法新增某实例，因为实例UUID为空");if(this.instances.has(e.instanceUuid))throw new Error(`The application instance ${e.instanceUuid} already exists.`);this.instances.set(e.instanceUuid,e),e.on("data",((...t)=>{this.emit("data",e.instanceUuid,...t)})),e.on("exit",((...t)=>{this.emit("exit",{instanceUuid:e.instanceUuid,instanceName:e.config.nickname},...t)})),e.on("open",((...t)=>{this.emit("open",{instanceUuid:e.instanceUuid,instanceName:e.config.nickname},...t)})),e.on("failure",((...t)=>{this.emit("failure",{instanceUuid:e.instanceUuid,instanceName:e.config.nickname},...t)}))}removeInstance(e,t){const n=this.getInstance(e);if(n)return n.destroy(),this.instances.delete(e),f.default.delete("InstanceConfig",e),g.default.deleteInstanceAllTask(e),t&&r.default.remove(n.config.cwd,(e=>{})),!0;throw new Error("Instance does not exist")}forward(e,t){try{this.instanceStream.requestForward(t,e)}catch(e){}}stopForward(e,t){try{this.instanceStream.cannelForward(t,e)}catch(e){}}forEachForward(e,t){this.instanceStream.forwardViaCallback(e,(e=>{t(e)}))}getInstance(e){return this.instances.get(e)}getQueryMapWrapper(){return new h.QueryMapWrapper(this.instances)}exists(e){return this.instances.has(e)}async exit(){let e=[];for(const t of this.instances){const n=t[1];n.status()!=o.default.STATUS_STOP&&(u.default.info(`Instance ${n.config.nickname} (${n.instanceUuid}) is running or busy, and is being forced to end.`),e.push(n.execCommand(new c.default).then((()=>{f.default.store("InstanceConfig",n.instanceUuid,n.config),u.default.info(`Instance ${n.config.nickname} (${n.instanceUuid}) saved successfully.`)}))))}await Promise.all(e)}}t.default=new w},9945:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(7344)),i=s(n(9597)),o=s(n(2270)),a=s(n(3018)),c=s(n(1155)),u=s(n(3777)),l=s(n(5202)),f=s(n(7765)),d=s(n(223)),p=s(n(7701));class h{constructor(){this.instanceUuid="",this.name="",this.count=1,this.time="",this.action="",this.payload="",this.type=1}}class m{constructor(e,t){this.callback=e,this.time=t,this.job=0,this.job=setInterval(e,1e3*t)}cancel(){clearInterval(this.job)}}class g{constructor(e,t){this.config=e,this.job=t}}t.default=new class{constructor(){this.taskMap=new Map,this.taskJobMap=new Map,o.default.list("TaskConfig").forEach((e=>{const t=o.default.load("TaskConfig",h,e);try{this.registerScheduleJob(t,!1)}catch(e){}}))}registerScheduleJob(e,t=!0){var n;const s=`${e.instanceUuid}`;if(this.taskMap.has(s)||this.taskMap.set(s,[]),(null===(n=this.taskMap.get(s))||void 0===n?void 0:n.length)>=8)throw new Error("无法继续创建计划任务，以达到上限");if(!this.checkTask(s,e.name))throw new Error("已存在重复的任务");if(!p.default.checkFileName(e.name))throw new Error("非法的计划名，仅支持下划线，数字，字母和部分本地语言");let i;if(t&&a.default.info(`创建计划任务 ${e.name}:\n${JSON.stringify(e)}`),1===e.type){let t=Number(e.time);(isNaN(t)||t<1)&&(t=1),i=new m((()=>{this.action(e),-1!==e.count&&(1===e.count?(i.cancel(),this.deleteTask(s,e.name)):(e.count--,this.updateTaskConfig(s,e.name,e)))}),t)}else{const t=e.time.split(" ");[0,1,2].forEach((n=>{if(isNaN(Number(t[n]))&&Number(t[n])>=0)throw new Error(`计划任务创建错误，不正确的时间表达式: \n${e.name}: ${t}\n请尝试删除 data/TaskConfig/${e.name}.json 文件解决此问题`)})),i=r.default.scheduleJob(e.time,(()=>{this.action(e),-1!==e.count&&(1===e.count?(i.cancel(),this.deleteTask(s,e.name)):(e.count--,this.updateTaskConfig(s,e.name,e)))}))}const c=new g(e,i);this.taskMap.get(s).push(c),t&&o.default.store("TaskConfig",`${s}_${c.config.name}`,c.config),t&&a.default.info(`创建计划任务 ${e.name} 完毕`)}listScheduleJob(e){const t=`${e}`,n=this.taskMap.get(t)||[],s=[];return n.forEach((e=>{s.push(e.config)})),s}async action(e){try{const t=e.payload,n=e.instanceUuid,s=i.default.getInstance(n);if(!s)return this.deleteScheduleTask(e.instanceUuid,e.name);const r=s.status();if("start"===e.action&&0===r)return await s.exec(new c.default("ScheduleJob"));if("stop"===e.action&&3===r)return await s.exec(new u.default);if("restart"===e.action&&3===r)return await s.exec(new f.default);if("command"===e.action&&3===r)return await s.exec(new l.default(t));if("kill"===e.action)return await s.exec(new d.default)}catch(t){a.default.error(`实例 ${e.instanceUuid} 计划任务 ${e.name} 执行错误: \n ${t} `)}}deleteInstanceAllTask(e){const t=this.listScheduleJob(e);t&&t.forEach((t=>{this.deleteScheduleTask(e,t.name)}))}deleteScheduleTask(e,t){const n=`${e}`;this.deleteTask(n,t)}deleteTask(e,t){this.taskMap.get(e).forEach(((e,n,s)=>{e.config.name===t&&(e.job.cancel(),s.splice(n,1))})),o.default.delete("TaskConfig",`${e}_${t}`)}checkTask(e,t){let n=!0;return this.taskMap.get(e).forEach(((e,s,r)=>{e.config.name===t&&(n=!1)})),n}updateTaskConfig(e,t,n){const s=this.taskMap.get(e);for(const e in s)if(s[e].config.name===t){s[e].config=n;break}}checkScheduledTaskLimit(e){for(const e of this.taskMap);}}},9095:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(n(4521)),c=i(n(8742)),u=o(n(9597)),l=n(8222),f=o(n(3018)),d=o(n(1155)),p=o(n(3777)),h=o(n(223)),m=o(n(5202)),g=a.default.createInterface({input:process.stdin,output:process.stdout});console.log('[终端] 守护进程拥有基本的交互功能，请输入"help"查看更多信息'),function e(){g.question("> ",(async t=>{try{const n=t.split(" ");f.default.info(`[Terminal] ${t}`);const s=await async function(e,t,n,s){if("instance"===e)return"start"===t?(u.default.getInstance(n).exec(new d.default("Terminal")),"Done."):"stop"===t?(u.default.getInstance(n).exec(new p.default),"Done."):"kill"===t?(u.default.getInstance(n).exec(new h.default),"Done."):"send"===t?(u.default.getInstance(n).exec(new m.default(s)),"Done."):"Parameter error";if("instances"===e){const e=u.default.instances;let t="instance name | instance UUID | status code\n";return e.forEach((e=>{t+=`${e.config.nickname} ${e.instanceUuid} ${e.status()}\n`})),t+="\nStatus Explanation:\n Busy=-1;Stop=0;Stopping=1;Starting=2;Running=3;\n",t}if("sockets"===e){const e=c.socketObjects();let t="IP address   |   identifier\n";return e.forEach((e=>{t+=`${e.handshake.address} ${e.id}\n`})),t+=`Total ${e.size} online.\n`,t}if("key"==e)return l.globalConfiguration.config.key;if("exit"==e)try{f.default.info("Preparing to shut down the daemon..."),await u.default.exit(),f.default.info("The data is saved, thanks for using, goodbye!"),f.default.info("closed."),process.exit(0)}catch(e){f.default.error("Failed to end the program. Please check the file permissions and try again. If you still can't close it, please use Ctrl+C to close.",e)}return"help"==e?(console.log("----------- Help document -----------"),console.log(" instances view all instances"),console.log(" Sockets view all linkers"),console.log(" key view key"),console.log(" exit to close this program (recommended method)"),console.log(" instance start <UUID> to start the specified instance"),console.log(" instance stop <UUID> to start the specified instance"),console.log(" instance kill <UUID> to start the specified instance"),console.log(" instance send <UUID> <CMD> to send a command to the instance"),console.log("----------- Help document -----------"),"\n"):void 0}(n[0],n[1],n[2],n[3]);s?console.log(s):console.log(`Command ${t} does not exist, type help to get help.`)}catch(e){f.default.error("[Terminal]",e)}finally{e()}}))}()},4310:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getVersion=t.initVersionManager=void 0;const a=i(n(4470)),c=o(n(6473)),u=o(n(3018)),l="package.json";t.initVersionManager=function(){try{if(c.default.set("version","Unknown"),a.existsSync(l)){const e=JSON.parse(a.readFileSync(l,{encoding:"utf-8"}));e.version&&c.default.set("version",e.version)}}catch(e){u.default.error("版本检查失败",e)}},t.getVersion=function(){return c.default.get("version","Unknown")}},1511:e=>{e.exports=require("@koa/router")},5500:e=>{e.exports=require("archiver")},7416:e=>{e.exports=require("compressing")},4856:e=>{e.exports=require("dockerode")},1239:e=>{e.exports=require("events")},4470:e=>{e.exports=require("fs-extra")},5135:e=>{e.exports=require("iconv-lite")},1406:e=>{e.exports=require("koa")},5004:e=>{e.exports=require("koa-body")},8094:e=>{e.exports=require("log4js")},7344:e=>{e.exports=require("node-schedule")},7601:e=>{e.exports=require("node-stream-zip")},7411:e=>{e.exports=require("os-utils")},3691:e=>{e.exports=require("pidusage")},8231:e=>{e.exports=require("properties")},3952:e=>{e.exports=require("socket.io")},5828:e=>{e.exports=require("uuid")},9066:e=>{e.exports=require("yaml")},2081:e=>{e.exports=require("child_process")},1891:e=>{e.exports=require("dgram")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},4521:e=>{e.exports=require("readline")}},t={};!function n(s){var r=t[s];if(void 0!==r)return r.exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,n),i.exports}(3165)})();