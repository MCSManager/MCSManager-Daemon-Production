(()=>{"use strict";var e={6672:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5233);a.initVersionManager();const c=a.getVersion();console.log(`______  _______________________  ___                                         \n___   |/  /_  ____/_  ___/__   |/  /_____ _____________ _______ _____________\n__  /|_/ /_  /    _____ \\__  /|_/ /_  __  /_  __ \\  __  /_  __  /  _ \\_  ___/\n_  /  / / / /___  ____/ /_  /  / / / /_/ /_  / / / /_/ /_  /_/ //  __/  /    \n/_/  /_/  \\____/  /____/ /_/  /_/  \\__,_/ /_/ /_/\\__,_/ _\\__, / \\___//_/     \n________                                                /____/                                          \n___  __ \\_____ ____________ ________________ \n__  / / /  __  /  _ \\_  __  __ \\  __ \\_  __ \\\n_  /_/ // /_/ //  __/  / / / / / /_/ /  / / /\n/_____/ \\__,_/ \\___//_/ /_/ /_/\\____//_/ /_/   \n\n + Released under the GPL-3.0 License\n + Copyright 2021 Suwings\n + Version ${c}\n`);const u=i(n(3685)),l=n(3952),d=i(n(3541));d.default.info("欢迎使用 MCSManager 守护进程");const f=n(5533),p=o(n(8963)),h=o(n(5091)),_=o(n(4754)),g=i(n(7062));f.globalConfiguration.load();const m=f.globalConfiguration.config,y=h.initKoa(),w=u.default.createServer(y.callback());w.listen(m.port,m.ip);const k=new l.Server(w,{serveClient:!1,pingInterval:5e3,pingTimeout:5e3,cookie:!1,path:"/socket.io",cors:{origin:"*",methods:["GET","POST","PUT","DELETE"]}});try{d.default.info("正在读取本地应用实例中"),g.default.loadInstances(),d.default.info(`所有应用实例已加载，总计 ${g.default.instances.size} 个`)}catch(e){d.default.error("读取本地实例文件失败:",e),process.exit(-1)}k.on("connection",(e=>{d.default.info(`会话 ${e.id}(${e.handshake.address}) 已连接.`),_.addGlobalSocket(e),p.navigation(e),e.on("disconnect",(()=>{_.delGlobalSocket(e);for(const t of e.eventNames())e.removeAllListeners(t);d.default.info(`会话 ${e.id}(${e.handshake.address}) 已断开`)}))})),process.on("uncaughtException",(function(e){d.default.error("错误报告 (uncaughtException):",e)})),process.on("unhandledRejection",((e,t)=>{d.default.error("错误报告 (unhandledRejection):",e,t)})),d.default.info("守护进程现已成功启动"),d.default.info("================================"),d.default.info(`访问地址 ${m.ip?m.ip:"localhost"}:${m.port}`),d.default.info(`访问密钥 ${m.key}`),d.default.info("密钥作为守护进程唯一认证手段"),d.default.info("================================"),console.log(""),n(158),process.on("SIGINT",(function(){try{console.log("\n\n\n\n"),d.default.warn("SIGINT close process signal detected."),g.default.exit(),d.default.info("The data is saved, thanks for using, goodbye!"),d.default.info("Closed.")}catch(e){d.default.error("ERROR:",e)}finally{process.exit(0)}}))},383:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.decompress=t.compress=void 0;const a=i(n(2037)),c=i(n(4470)),u=(a.default.platform(),o(n(7416)));i(n(2081)),t.compress=async function(e,t){return await async function(e,t){const n=new u.zip.Stream;t.forEach((e=>{n.addEntry(e)}));const s=c.default.createWriteStream(e);n.pipe(s)}(e,t)},t.decompress=async function(e,t){return await async function(e,t){return await u.zip.uncompress(e,t,{zipFileNameEncoding:"GBK"})}(e,t)}},2887:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class n{static set(e,t){n.map.set(e,t)}static get(e,t){return n.map.has(e)?n.map.get(e):t}static del(e){return n.map.delete(e)}}t.default=n,n.map=new Map},9231:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.listenMap=new Map}requestForward(e,t){if(this.listenMap.has(t)){const n=this.listenMap.get(t);for(const t of n)if(t.id===e.id)throw new Error(`此 Socket ${e.id} 已经存在于指定实例监听表中`);n.push(e)}else this.listenMap.set(t,[e])}cannelForward(e,t){if(!this.listenMap.has(t))throw new Error(`指定 ${t} 并不存在于监听表中`);const n=this.listenMap.get(t);n.forEach(((t,s)=>{t.id===e.id&&n.splice(s,1)}))}forward(e,t){this.listenMap.get(e).forEach((e=>{e&&e.connected&&e.emit("instance/stdout",t)}))}forwardViaCallback(e,t){this.listenMap.has(e)&&this.listenMap.get(e).forEach((e=>{e&&e.connected&&t(e)}))}hasListenInstance(e){return this.listenMap.has(e)&&this.listenMap.get(e).length>0}}},1301:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1808));t.default=class{constructor(e,t){this.port=e,this.host=t,this.status={online:null,version:null,motd:null,current_players:null,max_players:null,latency:null}}getStatus(){return new Promise(((e,t)=>{var n=(new Date).getTime();const s=r.default.connect(this.port,this.host,(()=>{this.status.latency=Math.round((new Date).getTime()-n);let e=Buffer.from([254,1]);s.write(e)}));s.on("data",(t=>{var n=t.toString().split("\0\0");this.status={host:this.host,port:this.port,status:!0,version:n[2].replace(/\u0000/g,""),motd:n[3].replace(/\u0000/g,""),current_players:n[4].replace(/\u0000/g,""),max_players:n[5].replace(/\u0000/g,""),latency:this.status.latency},function(e){let t=e.replace(/\u0000/g,"");Buffer.from(t)}(n[3]),s.end(),e(this.status)})),s.on("end",(()=>{})),s.on("error",(e=>{t(e)}))}))}async asyncStatus(){return await this.getStatus()}}},8412:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QueryWrapper=t.LocalFileSource=t.MySqlSource=t.QueryMapWrapper=void 0,t.QueryMapWrapper=class{constructor(e){this.map=e}select(e){const t=[];return this.map.forEach((n=>{e(n)&&t.push(n)})),t}page(e,t=1,n=10){const s=(t-1)*n,r=s+n;let o=e.length,i=0;for(;o>0;)o-=n,i++;return{page:t,pageSize:n,maxPage:i,data:e.slice(s,r)}}},t.MySqlSource=class{},t.LocalFileSource=class{constructor(e){this.data=e}selectPage(e,t=1,n=10){const s=[];return this.data.forEach((t=>{for(const n in e){const s=t[n],r=e[n];if("%"==r[0]){if(!s.includes(r.slice(1,r.length-1)))return!1}else if(r!==s)return!1}s.push(t)})),this.page(s,t,n)}page(e,t=1,n=10){const s=(t-1)*n,r=s+n;let o=e.length,i=0;for(;o>0;)o-=n,i++;return{page:t,pageSize:n,maxPage:i,total:e.length,data:e.slice(s,r)}}select(e){return null}update(e,t){}delete(e){}insert(e){}},t.QueryWrapper=class{constructor(e){this.dataSource=e}selectPage(e,t=1,n=10){return this.dataSource.selectPage(e,t,n)}}},9732:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1017)),o=s(n(4470));class i{store(e,t,n){const s=r.default.join(i.STIRAGE_DATA_PATH,e);o.default.existsSync(s)||o.default.mkdirsSync(s);const a=r.default.join(s,`${t}.json`),c=JSON.stringify(n,null,4);o.default.writeFileSync(a,c,{encoding:"utf-8"})}load(e,t,n){const s=r.default.join(i.STIRAGE_DATA_PATH,e);o.default.existsSync(s)||o.default.mkdirsSync(s);const a=r.default.join(s,`${n}.json`);if(!o.default.existsSync(a))return null;const c=o.default.readFileSync(a,{encoding:"utf-8"}),u=JSON.parse(c),l=new t;for(const e of Object.keys(l))void 0!==u[e]&&(l[e]=u[e]);return l}list(e){const t=r.default.join(i.STIRAGE_DATA_PATH,e);o.default.existsSync(t)||o.default.mkdirsSync(t);const n=o.default.readdirSync(t),s=new Array;return n.forEach((e=>{s.push(e.replace(r.default.extname(e),""))})),s}delete(e,t){const n=r.default.join(i.STIRAGE_DATA_PATH,e,`${t}.json`);o.default.existsSync(n)&&o.default.removeSync(n)}}i.STIRAGE_DATA_PATH=r.default.normalize(r.default.join(process.cwd(),"data")),i.STIRAGE_INDEX_PATH=r.default.normalize(r.default.join(process.cwd(),"data","index")),t.default=new i},6397:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e){this.info=e}async exec(e){}}},5264:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.commandStringToArray=void 0,t.commandStringToArray=function(e){const t="{quotes}";let n=0,s=e.length;const r=[];function o(t){if(t!=n){const s=e.slice(n,t);return n=t,r.push(s)}}function i(t){for(let n=t+1;n<s;n++)if('"'===e[n])return n;throw new Error("错误的命令双引号，无法找到成对双引号，如需使用单个双引号请使用 {quotes} 符号")}if(function(){for(let t=n;t<s;t++){const a=e[t];if(" "!==a){if('"'===a&&(t=i(t)),t+1>=s){r.push(e.slice(n));break}}else o(t),n++}}(),0==r.length)throw new Error("错误的命令长度，请确保命令格式正确");for(const e in r){const n=r[e];for('"'===n[0]&&'"'===n[n.length-1]&&(r[e]=n.slice(1,n.length-1));-1!=r[e].indexOf(t);)r[e]=r[e].replace(t,'"')}return r}},5755:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397));class o extends r.default{constructor(e){super("SendCommand"),this.cmd=e}async exec(e){return await e.execPreset("write",this.cmd)}}t.default=o},7338:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(3948)),o=s(n(6397)),i=s(n(3095)),a=s(n(1406)),c=s(n(950)),u=s(n(2971)),l=s(n(7362)),d=s(n(5948)),f=s(n(1981)),p=s(n(63)),h=s(n(9641)),_=s(n(7830)),g=s(n(3229)),m=s(n(9165));class y extends o.default{constructor(){super("FuntionDispatcher")}async exec(e){e.lifeCycleTaskManager.clearLifeCycleTask(),e.clearPreset(),e.lifeCycleTaskManager.registerLifeCycleTask(new g.default),e.config.processType&&"general"!==e.config.processType||(e.setPreset("start",new l.default),e.setPreset("write",new p.default),e.setPreset("stop",new d.default),e.setPreset("kill",new f.default),e.setPreset("restart",new h.default)),"docker"===e.config.processType&&(e.setPreset("start",new _.default),e.setPreset("write",new p.default),e.setPreset("stop",new d.default),e.setPreset("kill",new f.default),e.setPreset("restart",new h.default)),e.config.type.includes(r.default.TYPE_UNIVERSAL)&&(e.setPreset("update",new u.default),e.setPreset("getPlayer",new u.default)),e.config.type.includes(r.default.TYPE_MINECRAFT_JAVA)&&(e.setPreset("update",new a.default),e.setPreset("getPlayer",new c.default),e.lifeCycleTaskManager.registerLifeCycleTask(new i.default)),e.config.type.includes(r.default.TYPE_MINECRAFT_BEDROCK)&&(e.setPreset("update",new u.default),e.setPreset("getPlayer",new m.default),e.lifeCycleTaskManager.registerLifeCycleTask(new i.default))}}t.default=y},7830:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(3948)),o=s(n(6397)),i=s(n(4856)),a=s(n(3541)),c=n(1239),u=s(n(4470)),l=n(5264),d=process.getuid?process.getuid:()=>0,f=process.getgid?process.getgid:()=>0;class p extends Error{constructor(e){super(e)}}class h extends c.EventEmitter{constructor(e){super(),this.container=e}async start(){await this.container.start(),this.pid=this.container.id;const e=this.stream=await this.container.attach({stream:!0,stdout:!0,stderr:!0,stdin:!0});e.on("data",(e=>this.emit("data",e))),e.on("error",(e=>this.emit("data",e))),this.wait()}write(e){this.stream&&this.stream.write(e)}kill(e){return this.container.kill(),!0}async destroy(){try{await this.container.remove()}catch(e){}}wait(){this.container.wait((async e=>{this.destroy(),this.emit("exit",e)}))}}class _ extends o.default{constructor(){super("DockerStartCommand")}async exec(e,t="Unknown"){if(e.status()!=r.default.STATUS_STOP)return e.failure(new p("实例未处于关闭状态，无法再进行启动"));if(!(e.config.startCommand&&e.config.cwd&&e.config.ie&&e.config.oe))return e.failure(new p("启动命令，输入输出编码或工作目录为空值"));if(!u.default.existsSync(e.absoluteCwdPath()))return e.failure(new p("工作目录并不存在"));try{e.setLock(!0),e.status(r.default.STATUS_STARTING),e.startCount++;const n=l.commandStringToArray(e.config.startCommand),s=e.absoluteCwdPath(),o=e.config.docker.ports,c={},u={};for(const e of o){const t=e.split("/");if(2!=t.length)continue;const n=t[0],s=t[1],r=n.split(":");2==r.length&&(c[`${r[1]}/${s}`]=[{HostPort:r[0]}],u[`${r[1]}/${s}`]={})}let p=0;e.config.docker.memory&&(p=1024*e.config.docker.memory*1024),a.default.info("----------------"),a.default.info(`会话 ${t}: 请求开启实例`),a.default.info(`实例标识符: [${e.instanceUuid}]`),a.default.info(`启动命令: ${n.join(" ")}`),a.default.info(`工作目录: ${s}`),a.default.info(`端口: ${JSON.stringify(c)}`),a.default.info(`内存限制: ${p} MB`),a.default.info("类型: Docker 容器"),a.default.info("----------------");const _=new i.default,g=await _.createContainer({Image:e.config.docker.image,AttachStdin:!0,AttachStdout:!0,AttachStderr:!0,Tty:!0,User:`${d()}:${f()}`,WorkingDir:"/workspace/",Cmd:n,OpenStdin:!0,StdinOnce:!1,ExposedPorts:u,HostConfig:{Memory:p,Binds:[`${s}:/workspace/`],AutoRemove:!0,PortBindings:c}}),m=new h(g);await m.start(),e.started(m),a.default.info(`实例 ${e.instanceUuid} 成功启动.`)}catch(t){return e.instanceStatus=r.default.STATUS_STOP,e.releaseResources(),e.failure(t)}finally{e.setLock(!1)}}}t.default=_},63:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5135),o=s(n(6397));class i extends o.default{constructor(){super("SendCommand")}async exec(e,t){e.process||e.failure(new Error("命令执行失败，因为实例实际进程不存在.")),e.process.write(r.encode(t,e.config.oe)),e.process.write("\n")}}t.default=i},1981:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397));class o extends r.default{constructor(){super("KillCommand")}async exec(e){e.process&&e.process.kill("SIGKILL"),e.setLock(!1)}}t.default=o},9641:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(3948)),o=s(n(6397));class i extends o.default{constructor(){super("GeneralRestartCommand")}async exec(e){try{e.println("INFO","重启实例计划开始执行..."),await e.execPreset("stop"),e.setLock(!0);const t=e.startCount,n=setInterval((async()=>{try{if(t!==e.startCount)throw new Error("重启实例状态错误，实例已被启动过，上次状态的重启计划取消");if(e.status()!==r.default.STATUS_STOPPING&&e.status()!==r.default.STATUS_STOP)throw new Error("重启实例状态错误，实例状态应该为停止中状态，现在变为正在运行，重启计划取消");e.status()===r.default.STATUS_STOP&&(e.println("INFO","检测到服务器已停止，正在重启实例..."),await e.execPreset("start"),e.setLock(!1),clearInterval(n))}catch(t){throw clearInterval(n),e.setLock(!1),t}}),1e3)}catch(t){e.setLock(!1),e.failure(t)}}}t.default=i},7362:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(2037)),o=s(n(3948)),i=s(n(3541)),a=s(n(4470)),c=s(n(6397)),u=s(n(1239)),l=n(2081),d=n(5264);class f extends Error{constructor(e){super(e)}}class p extends u.default{constructor(e){super(),this.process=e,this.pid=this.process.pid,e.stdout.on("data",(e=>this.emit("data",e))),e.stderr.on("data",(e=>this.emit("data",e))),e.on("exit",(e=>this.emit("exit",e)))}write(e){return this.process.stdin.write(e)}kill(e){return"win32"===r.default.platform()?l.exec(`taskkill /PID ${this.pid} /T /F`,((e,t,n)=>{i.default.info(`实例进程 ${this.pid} 正在使用指令强制结束.`),i.default.info(`实例进程 ${this.pid} 强制结束结果:\n Error: ${e}\n Stdout: ${t}`)})):"linux"===r.default.platform()?l.exec(`kill -s 9 ${this.pid}`,((e,t,n)=>{i.default.info(`实例进程 ${this.pid} 正在使用指令强制结束.`),i.default.info(`实例进程 ${this.pid} 强制结束结果:\n Error: ${e}\n Stdout: ${t}`)})):void(e?this.process.kill(e):this.process.kill("SIGKILL"))}async destroy(){try{if(this.process&&this.process.stdout&&this.process.stderr){for(const e of this.process.stdout.eventNames())this.process.stdout.removeAllListeners(e);for(const e of this.process.stderr.eventNames())this.process.stderr.removeAllListeners(e);for(const e of this.process.eventNames())this.process.removeAllListeners(e);this.process.stdout.destroy(),this.process.stderr.destroy()}}catch(e){}}}class h extends c.default{constructor(){super("StartCommand")}async exec(e,t="Unknown"){if(e.status()!=o.default.STATUS_STOP)return e.failure(new f("实例未处于关闭状态，无法再进行启动"));if(!(e.config.startCommand&&e.config.cwd&&e.config.ie&&e.config.oe))return e.failure(new f("启动命令，输入输出编码或工作目录为空值"));if(!a.default.existsSync(e.absoluteCwdPath()))return e.failure(new f("工作目录并不存在"));try{e.setLock(!0),e.status(o.default.STATUS_STARTING),e.startCount++;const n=d.commandStringToArray(e.config.startCommand),s=n[0],r=n.slice(1);i.default.info("----------------"),i.default.info(`会话 ${t}: 请求开启实例.`),i.default.info(`实例标识符: [${e.instanceUuid}]`),i.default.info(`启动命令: ${JSON.stringify(n)}`),i.default.info(`工作目录: ${e.config.cwd}`),i.default.info("----------------");const a=l.spawn(s,r,{cwd:e.config.cwd,stdio:"pipe",windowsHide:!0});if(!a||!a.pid)throw new f("进程启动失败，进程PID为空，请检查启动命令和相关参数.");const c=new p(a);e.started(c),i.default.info(`实例 ${e.instanceUuid} 成功启动 PID: ${a.pid}.`)}catch(t){return e.instanceStatus=o.default.STATUS_STOP,e.releaseResources(),e.failure(t)}finally{e.setLock(!1)}}}t.default=h},5948:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(3948)),o=s(n(6397)),i=s(n(5755));class a extends o.default{constructor(){super("StopCommand")}async exec(e){const t=e.config.stopCommand;if(e.status()===r.default.STATUS_STOP||!e.process)return e.failure(new Error("实例未处于运行中状态，无法进行停止."));e.status(r.default.STATUS_STOPPING),"^c"==t.toLocaleLowerCase()?e.process.kill("SIGINT"):await e.exec(new i.default(t));const n=e.startCount;return setTimeout((()=>{e.status()===r.default.STATUS_STOPPING&&e.startCount===n&&(e.println("ERROR","关闭命令已发出但长时间未能关闭实例，可能是实例关闭命令错误或实例进程假死导致，现在将恢复到运行中状态，可使用强制终止指令结束进程。"),e.status(r.default.STATUS_RUNNING))}),6e5),e}}t.default=a},107:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397));class o extends r.default{constructor(){super("KillCommand")}async exec(e){return e.config.eventTask&&e.config.eventTask.autoRestart&&(e.config.eventTask.ignore=!0),await e.execPreset("kill")}}t.default=o},2971:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397));class o extends r.default{constructor(){super("NullCommand")}async exec(){}}t.default=o},3612:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(3691)),o=s(n(6397));class i extends o.default{constructor(){super("ProcessInfo")}async exec(e){let t={cpu:0,memory:0,ppid:0,pid:0,ctime:0,elapsed:0,timestamp:0};return e.process&&e.process.pid&&(t=await r.default(e.process.pid)),t}}t.default=i},6530:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397));class o extends r.default{constructor(){super("RestartCommand")}async exec(e){return e.config.eventTask&&e.config.eventTask.autoRestart&&(e.config.eventTask.ignore=!0),await e.execPreset("restart")}}t.default=o},2924:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397));Error;class o extends r.default{constructor(e="Unknown"){super("StartCommand"),this.source=e}async exec(e){const t=new Date(e.config.endTime).getTime();if(t&&t<=(new Date).getTime())throw new Error("实例使用到期时间已到，无法再启动实例");return await e.execPreset("start",this.source)}}t.default=o},3265:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397));class o extends r.default{constructor(){super("StopCommand")}async exec(e){return e.config.eventTask&&e.config.eventTask.autoRestart&&(e.config.eventTask.ignore=!0),await e.execPreset("stop")}}t.default=o},3095:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.name="RefreshPlayer",this.status=0,this.task=null}async start(e){this.task=setInterval((async()=>{try{const t=await e.execPreset("getPlayer");if(!t)return;e.info.maxPlayers=t.max_players?t.max_players:-1,e.info.currentPlayers=t.current_players?t.current_players:-1,e.info.version=t.version?t.version:""}catch(e){}}),3e3)}async stop(e){e.info.maxPlayers=-1,e.info.currentPlayers=-1,e.info.version="",clearInterval(this.task)}}},3229:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(107));t.default=class{constructor(){this.status=0,this.name="TimeCheck",this.task=null}async start(e){this.task=setInterval((async()=>{const t=new Date(e.config.endTime).getTime();t&&t<=(new Date).getTime()&&(await e.exec(new r.default),clearInterval(this.task))}),36e5)}async stop(e){clearInterval(this.task)}}},5533:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Config=t.globalConfiguration=void 0;const r=n(5828),o=s(n(9732));class i{constructor(){this.version=1,this.ip="",this.port=24444,this.key=function(){const e=`${r.v4().replace(/\-/gim,"")}`;return e.slice(0,e.length/2-1)+`${r.v4().replace(/\-/gim,"")}`}()}}t.Config=i;class a{constructor(){this.config=new i}load(){let e=o.default.load("Config",i,a.ID);null==e&&(e=new i,o.default.store("Config",a.ID,e)),this.config=e}store(){o.default.store("Config",a.ID,this.config)}}a.ID="global";const c=new a;t.globalConfiguration=c},620:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t,n,s){this.uuid=e,this.socket=t,this.session=n,this.event=s}response(e){return this}}},453:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(3948));t.default=class{constructor(){this.nickname="Undefined",this.startCommand="",this.stopCommand="^C",this.cwd=".",this.ie="utf-8",this.oe="utf-8",this.createDatetime=(new Date).toLocaleDateString(),this.lastDatetime="--",this.type=r.default.TYPE_UNIVERSAL,this.tag=[],this.endTime=null,this.processType="general",this.eventTask={autoStart:!1,autoRestart:!1,ignore:!1},this.docker={image:"",memory:1024,ports:[],cpu:1,maxSpace:0,cpusetCpus:"",io:0,network:0,networkMode:"bridge"},this.pingConfig={ip:"",port:25565,type:1}}}},3948:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1239),o=s(n(5135)),i=s(n(1017)),a=s(n(9732)),c=n(3092),u=n(521),l=s(n(7338)),d=s(n(2924));class f extends r.EventEmitter{constructor(e,t){if(super(),this.lifeCycleTaskManager=new c.LifeCycleTaskManager(this),this.presetCommandManager=new u.PresetCommandManager(this),this.info={currentPlayers:-1,maxPlayers:-1,version:""},!e||!t)throw new Error("初始化实例失败，唯一标识符或配置参数为空");this.instanceStatus=f.STATUS_STOP,this.instanceUuid=e,this.lock=!1,this.config=t,this.process=null,this.startCount=0}parameters(e){if(this.status()!=f.STATUS_STOP)throw new Error("实例运行时无法修改任何实例参数");null!=e.nickname&&(this.config.nickname=e.nickname),null!=e.startCommand&&(this.config.startCommand=e.startCommand),null!=e.stopCommand&&(this.config.stopCommand=e.stopCommand),null!=e.cwd&&(this.config.cwd=e.cwd),null!=e.ie&&(this.config.ie=e.ie),null!=e.oe&&(this.config.oe=e.oe),null!=e.endTime&&(this.config.endTime=e.endTime),null!=e.processType&&(this.config.processType=e.processType),e.docker&&(null!=e.docker.image&&(this.config.docker.image=e.docker.image),e.docker.memory&&(this.config.docker.memory=Number(e.docker.memory)),null!=e.docker.cpu&&(this.config.docker.cpu=e.docker.cpu),null!=e.docker.ports&&(this.config.docker.ports=e.docker.ports),null!=e.docker.maxSpace&&(this.config.docker.maxSpace=Number(e.docker.maxSpace)),null!=e.docker.cpusetCpus&&(this.config.docker.cpusetCpus=e.docker.cpusetCpus),null!=e.docker.io&&(this.config.docker.io=Number(e.docker.io)),null!=e.docker.network&&(this.config.docker.network=Number(e.docker.network)),null!=e.docker.networkMode&&(this.config.docker.networkMode=e.docker.networkMode)),e.pingConfig&&(null!=e.pingConfig.ip&&(this.config.pingConfig.ip=e.pingConfig.ip),null!=e.pingConfig.port&&(this.config.pingConfig.port=Number(e.pingConfig.port)),null!=e.pingConfig.type&&(this.config.pingConfig.type=Number(e.pingConfig.type))),e.eventTask&&(null!=e.eventTask.autoStart&&(this.config.eventTask.autoStart=Boolean(e.eventTask.autoStart)),null!=e.eventTask.autoRestart&&(this.config.eventTask.autoRestart=Boolean(e.eventTask.autoRestart))),null!=e.type&&(this.config.type=e.type,this.forceExec(new l.default)),a.default.store("InstanceConfig",this.instanceUuid,this.config)}setLock(e){this.lock=e}async execCommand(e){if(this.lock)throw new Error(`此 ${e.info} 操作无法执行，因为实例处于锁定状态，请稍后再试.`);if(this.status()==f.STATUS_BUSY)throw new Error("当前实例正处于忙碌状态，无法执行任何操作.");return await e.exec(this)}async exec(e){return await this.execCommand(e)}async forceExec(e){return await e.exec(this)}status(e){return e&&(this.instanceStatus=e),this.instanceStatus}started(e){this.config.lastDatetime=this.fullTime(),e.on("data",(e=>this.emit("data",o.default.decode(e,this.config.oe)))),e.on("exit",(e=>this.stoped(e))),this.process=e,this.instanceStatus=f.STATUS_RUNNING,this.emit("open",this),this.lifeCycleTaskManager.execLifeCycleTask(1)}failure(e){throw this.emit("failure",e),this.println("错误",e.message),e}stoped(e=0){this.releaseResources(),this.instanceStatus!=f.STATUS_STOP&&(this.instanceStatus=f.STATUS_STOP,this.emit("exit",e),a.default.store("InstanceConfig",this.instanceUuid,this.config)),this.lifeCycleTaskManager.execLifeCycleTask(0),this.config.eventTask.autoRestart&&(this.config.eventTask.ignore||this.forceExec(new d.default("Event Task: Auto Restart")).then((()=>{this.println("信息","检测到实例关闭，根据主动事件机制，自动重启指令已发出...")})).catch((e=>{this.println("错误",`自动重启错误: ${e}`)})),this.config.eventTask.ignore=!1)}println(e,t){const n=`\n[MCSMANAGER] [${e}] ${t}\n`;this.emit("data",n)}releaseResources(){this.process=null}destroy(){this.process&&this.process.pid&&this.process.kill("SIGKILL"),this.process=null}fullTime(){const e=new Date;return e.toLocaleDateString()+" "+e.getHours()+":"+e.getMinutes()}absoluteCwdPath(){return this.config&&this.config.cwd?i.default.isAbsolute(this.config.cwd)?i.default.normalize(this.config.cwd):i.default.normalize(i.default.join(process.cwd(),this.config.cwd)):null}async usedSpace(e,t=4,n=0){return 0}async execPreset(e,t){if(this.presetCommandManager)return await this.presetCommandManager.execPreset(e,t);throw new Error("Preset Manager does not exist")}setPreset(e,t){this.presetCommandManager.setPreset(e,t)}getPreset(e){return this.presetCommandManager.getPreset(e)}clearPreset(){this.presetCommandManager.clearPreset()}}t.default=f,f.STATUS_BUSY=-1,f.STATUS_STOP=0,f.STATUS_STOPPING=1,f.STATUS_STARTING=2,f.STATUS_RUNNING=3,f.TYPE_UNIVERSAL="universal",f.TYPE_MINECRAFT_JAVA="minecraft/java",f.TYPE_MINECRAFT_BEDROCK="minecraft/bedrock"},3092:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LifeCycleTaskManager=void 0,t.LifeCycleTaskManager=class{constructor(e){this.self=e,this.lifeCycleTask=[]}registerLifeCycleTask(e){this.lifeCycleTask.push(e)}execLifeCycleTask(e){1==e?this.lifeCycleTask.forEach((e=>{0===e.status&&e.start(this.self),e.status=1})):this.lifeCycleTask.forEach((e=>{1===e.status&&e.stop(this.self),e.status=0}))}clearLifeCycleTask(){this.execLifeCycleTask(0),this.lifeCycleTask.splice(0,this.lifeCycleTask.length)}}},521:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PresetCommandManager=void 0,t.PresetCommandManager=class{constructor(e){this.self=e,this.preset=new Map}setPreset(e,t){this.preset.set(e,t)}getPreset(e){return this.preset.get(e)}async execPreset(e,t){const n=this.preset.get(e);if(!n)throw new Error(`预设命令 ${e} 不可用`);return await n.exec(this.self,t)}clearPreset(){this.preset.clear()}}},9037:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProcessConfig=void 0;const r=s(n(9066)),o=s(n(8231)),i=s(n(1017)),a=s(n(4470)),c="utf-8";t.ProcessConfig=class{constructor(e){this.iProcessConfig=e,e.path=i.default.normalize(e.path)}read(){const e=a.default.readFileSync(this.iProcessConfig.path,{encoding:c});return"yml"===this.iProcessConfig.type?r.default.parse(e):"properties"===this.iProcessConfig.type?o.default.parse(e):"json"===this.iProcessConfig.type?JSON.parse(e):"txt"===this.iProcessConfig.type?e:void 0}write(e){let t="";if("yml"===this.iProcessConfig.type&&(t=r.default.stringify(e)),"properties"===this.iProcessConfig.type&&(t=o.default.stringify(e),t=t.replace(/ = /gim,"=")),"json"===this.iProcessConfig.type&&(t=JSON.stringify(e)),"txt"===this.iProcessConfig.type&&(t=e.toString()),!t)throw new Error("写入内容为空，可能是配置文件类型不支持");a.default.writeFileSync(this.iProcessConfig.path,t,{encoding:c})}exists(){return a.default.existsSync(this.iProcessConfig.path)}}},950:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397)),o=s(n(1301));class i extends r.default{constructor(){super("MinecraftGetPlayersCommand")}async exec(e){return e.config.pingConfig.ip&&e.config.pingConfig.port?await new o.default(e.config.pingConfig.port,e.config.pingConfig.ip).getStatus():null}}t.default=i},9165:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1891),o=s(n(6397));class i extends o.default{constructor(){super("MinecraftBedrockGetPlayersCommand")}async exec(e){if(e.config.pingConfig.ip&&e.config.pingConfig.port){const t=await async function(e,t){const n=Buffer.from("01 00 00 00 00 00 06 18 20 00 FF FF 00 FE FE FE FE FD FD FD FD 12 34 56 78 A3 61 1C F8 BA 8F D5 60".replace(/ /g,""),"hex"),s=r.createSocket("udp4");var o={ip:e,port:t};return new Promise(((e,t)=>{s.on("error",(e=>{t(e)})),s.on("message",(t=>{const n=t.toString().split(";");e(n),s.close()})),s.send(n,o.port,o.ip,(e=>{e&&t(e)})),setTimeout((()=>t("request timeout")),5e3)}))}(e.config.pingConfig.ip,e.config.pingConfig.port);return{version:t[3],motd:t[0],current_players:t[4],max_players:t[5]}}return null}}t.default=i},1406:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(6397));class o extends r.default{constructor(){super("UpdateCommand")}async exec(e){console.log("更新实例.....")}}t.default=o},9366:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(4470)),c=o(n(4754)),u=n(8963),l=i(n(7062)),d=i(n(3541)),f=i(n(1017)),p=i(n(2924)),h=i(n(3265)),_=i(n(5755)),g=i(n(107)),m=i(n(3612)),y=i(n(8005)),w=n(9037),k=i(n(6530));u.routerApp.use(((e,t,n,s)=>{if("instance/new"==e&&n)return s();if("instance/overview"==e)return s();if("instance/select"==e)return s();if(e.startsWith("instance")){if(n.instanceUuids)return s();const r=n.instanceUuid;if(!l.default.exists(r))return c.error(t,e,{instanceUuid:r,err:`The operation failed, the instance ${r} does not exist.`})}s()})),u.routerApp.on("instance/select",((e,t)=>{const n=t.page||1,s=t.pageSize||1,r=t.condition,o=[],i=l.default.getQueryMapWrapper();let a=i.select((e=>!!e.config.nickname.includes(r.instanceName)));const u=i.page(a,n,s);u.data.forEach((e=>{o.push({instanceUuid:e.instanceUuid,started:e.startCount,status:e.status(),config:e.config,info:e.info})})),c.response(e,{page:u.page,pageSize:u.pageSize,maxPage:u.maxPage,data:o})})),u.routerApp.on("instance/overview",(e=>{const t=[];l.default.instances.forEach((e=>{t.push({instanceUuid:e.instanceUuid,started:e.startCount,status:e.status(),config:e.config,info:e.info})})),c.msg(e,"instance/overview",t)})),u.routerApp.on("instance/section",((e,t)=>{const n=t.instanceUuids,s=[];l.default.instances.forEach((e=>{n.forEach((t=>{t===e.instanceUuid&&s.push({instanceUuid:e.instanceUuid,started:e.startCount,status:e.status(),config:e.config,info:e.info})}))})),c.msg(e,"instance/section",s)})),u.routerApp.on("instance/detail",(async(e,t)=>{try{const n=t.instanceUuid,s=l.default.getInstance(n);let r=null,o=null;try{r=await s.forceExec(new m.default),o=await s.usedSpace(null,2)}catch(e){}c.msg(e,"instance/detail",{instanceUuid:s.instanceUuid,started:s.startCount,status:s.status(),config:s.config,info:s.info,space:o,processInfo:r})}catch(t){c.error(e,"instance/detail",{err:t.message})}})),u.routerApp.on("instance/new",((e,t)=>{const n=t;try{const t=l.default.createInstance(n);c.msg(e,"instance/new",{instanceUuid:t.instanceUuid,config:t.config})}catch(t){c.error(e,"instance/new",{instanceUuid:null,err:t.message})}})),u.routerApp.on("instance/update",((e,t)=>{const n=t.instanceUuid,s=t.config;try{l.default.getInstance(n).parameters(s),c.msg(e,"instance/update",{instanceUuid:n})}catch(t){c.error(e,"instance/update",{instanceUuid:n,err:t.message})}})),u.routerApp.on("instance/forward",((e,t)=>{const n=t.instanceUuid,s=t.forward;try{s?(d.default.info(`会话 ${e.socket.id} 请求转发实例 ${n} IO 流`),l.default.forward(n,e.socket)):(d.default.info(`会话 ${e.socket.id} 请求取消转发实例 ${n} IO 流`),l.default.stopForward(n,e.socket)),c.msg(e,"instance/forward",{instanceUuid:n})}catch(t){c.error(e,"instance/forward",{instanceUuid:n,err:t.message})}})),u.routerApp.on("instance/open",(async(e,t)=>{const n=t.disableResponse;for(const s of t.instanceUuids){const t=l.default.getInstance(s);try{await t.exec(new p.default(e.socket.id)),n||c.msg(e,"instance/open",{instanceUuid:s})}catch(t){n||(d.default.error(`实例${s}启动时错误: `,t),c.error(e,"instance/open",{instanceUuid:s,err:t.message}))}}})),u.routerApp.on("instance/stop",(async(e,t)=>{const n=t.disableResponse;for(const s of t.instanceUuids){const t=l.default.getInstance(s);try{await t.exec(new h.default),n||c.msg(e,"instance/stop",{instanceUuid:s})}catch(t){n||c.error(e,"instance/stop",{instanceUuid:s,err:t.message})}}})),u.routerApp.on("instance/restart",(async(e,t)=>{const n=t.disableResponse;for(const s of t.instanceUuids){const t=l.default.getInstance(s);try{await t.exec(new k.default),n||c.msg(e,"instance/restart",{instanceUuid:s})}catch(t){n||c.error(e,"instance/restart",{instanceUuid:s,err:t.message})}}})),u.routerApp.on("instance/kill",(async(e,t)=>{const n=t.disableResponse;for(const s of t.instanceUuids){const t=l.default.getInstance(s);if(t)try{await t.forceExec(new g.default),n||c.msg(e,"instance/kill",{instanceUuid:s})}catch(t){n||c.error(e,"instance/kill",{instanceUuid:s,err:t.message})}}})),u.routerApp.on("instance/command",(async(e,t)=>{const n=t.disableResponse,s=t.instanceUuid,r=t.command||"",o=l.default.getInstance(s);try{await o.exec(new _.default(r)),n||c.msg(e,"instance/command",{instanceUuid:s})}catch(t){n||c.error(e,"instance/command",{instanceUuid:s,err:t.message})}})),u.routerApp.on("instance/delete",((e,t)=>{const n=t.instanceUuids,s=t.deleteFile;for(const e of n)try{l.default.removeInstance(e,s)}catch(e){}c.msg(e,"instance/delete",n)})),u.routerApp.on("instance/stdin",((e,t)=>{const n=l.default.getInstance(t.instanceUuid);try{if("\r"==t.ch)return n.process.write("\n");n.process.write(t.ch)}catch(e){}})),u.routerApp.on("instance/process_config/list",((e,t)=>{const n=t.instanceUuid,s=t.files,r=[];try{const t=l.default.getInstance(n),o=new y.default(t.absoluteCwdPath());for(const e of s)o.check(e)&&r.push({file:e,check:!0});c.response(e,r)}catch(t){c.responseError(e,t)}})),u.routerApp.on("instance/process_config/file",((e,t)=>{const n=t.instanceUuid,s=t.fileName,r=t.config||null,o=t.type;try{const t=l.default.getInstance(n);if(!new y.default(t.absoluteCwdPath()).check(s))throw new Error("文件不存在或路径错误，文件访问被拒绝");const i=f.default.normalize(f.default.join(t.absoluteCwdPath(),s)),a=new w.ProcessConfig({fileName:s,redirect:s,path:i,type:o,info:null,fromLink:null});if(r)return a.write(r),c.response(e,!0);{const t=a.read();return c.response(e,t)}}catch(t){c.responseError(e,t)}})),u.routerApp.on("instance/outputlog",(async(e,t)=>{const n=t.instanceUuid;try{const t=f.default.join(l.default.LOG_DIR,`${n}.log`);if(a.default.existsSync(t)){const n=await a.default.readFile(t,{encoding:"utf-8"});return c.response(e,n)}c.responseError(e,new Error("终端日志文件不存在"))}catch(t){c.responseError(e,t)}}))},4765:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(8963),c=o(n(4754)),u=n(5533),l=i(n(3541)),d="TOP_LEVEL";a.routerApp.use((async(e,t,n,s)=>{const r=t.socket;if(e.startsWith("stream"))return s();if("auth"===e)return await s();if(!t.session)throw new Error("Session does not exist in authentication middleware.");return t.session.key===u.globalConfiguration.config.key&&t.session.type===d&&t.session.login&&t.session.id?await s():(l.default.warn(`会话 ${r.id}(${r.handshake.address}) 试图无权限访问 ${e} 现已阻止.`),c.error(t,"error","权限不足，非法访问"))})),a.routerApp.on("auth",((e,t)=>{t===u.globalConfiguration.config.key?(l.default.info(`会话 ${e.socket.id}(${e.socket.handshake.address}) 验证身份成功`),function(e,t){e.session.key=t,e.session.login=!0,e.session.id=e.socket.id,e.session.type=d,e.session}(e,t),c.msg(e,"auth",!0)):c.msg(e,"auth",!1)})),a.routerApp.on("connection",(e=>{const t=e.session;setTimeout((()=>{t.login||(e.socket.disconnect(),l.default.info(`会话 ${e.socket.id}(${e.socket.handshake.address}) 因长时间未验证身份而断开连接`))}),6e3)}))},4129:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1376),c=o(n(4754)),u=n(8963),l=o(n(4470)),d=i(n(1017)),f=n(5828),p=i(n(3541)),h=i(n(2037));u.routerApp.on("environment/images",(async(e,t)=>{try{if("win32"===h.default.platform())return c.responseError(e,"[Unsupported] Windows 系统暂不支持此功能");const t=(new a.DockerManager).getDocker(),n=await t.listImages();c.response(e,n)}catch(t){c.responseError(e,"无法获取镜像信息，请确保您已正确安装Docker环境")}})),u.routerApp.on("environment/containers",(async(e,t)=>{try{const t=(new a.DockerManager).getDocker(),n=await t.listContainers();c.response(e,n)}catch(t){c.responseError(e,t)}})),u.routerApp.on("environment/new_image",(async(e,t)=>{if("win32"===h.default.platform())return c.responseError(e,"[Unsupported] Windows 系统暂不支持此功能");try{const n=t.dockerFile,s=t.name,r=t.tag,o=f.v4(),i=d.default.normalize(d.default.join(process.cwd(),"tmp",o));l.existsSync(i)||l.mkdirsSync(i);const u=d.default.normalize(d.default.join(i,"Dockerfile"));await l.writeFile(u,n,{encoding:"utf-8"}),p.default.info(`守护进程正在创建镜像 ${s}:${r} DockerFile 如下:\n${n}\n`),c.response(e,!0);const h=`${s}:${r}`;try{await(new a.DockerManager).startBuildImage(i,h),p.default.info(`创建镜像 ${s}:${r} 完毕`)}catch(e){p.default.info(`创建镜像 ${s}:${r} 错误:${e}`)}}catch(t){c.responseError(e,t)}})),u.routerApp.on("environment/del_image",(async(e,t)=>{try{const n=t.imageId,s=(new a.DockerManager).getDocker().getImage(n);if(!s)throw new Error("Image does not exist");p.default.info(`守护进程正在删除镜像 ${n}`),await s.remove(),c.response(e,!0)}catch(t){c.responseError(e,t)}})),u.routerApp.on("environment/progress",(async e=>{try{const t={};a.DockerManager.builerProgress.forEach(((e,n)=>{t[n]=e})),c.response(e,t)}catch(t){c.responseError(e,t)}}))},1632:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(n(4754)),c=n(8963),u=i(n(7062)),l=n(1699);c.routerApp.use(((e,t,n,s)=>{if(e.startsWith("file/")){const s=n.instanceUuid;if(!u.default.exists(s))return a.error(t,e,{instanceUuid:s,err:`实例 ${s} 不存在`})}s()})),c.routerApp.on("file/list",((e,t)=>{try{const n=l.getFileManager(t.instanceUuid);n.cd(t.target);const s=n.list();a.response(e,s)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/mkdir",((e,t)=>{try{const n=t.target;l.getFileManager(t.instanceUuid).mkdir(n),a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/copy",(async(e,t)=>{try{const n=t.targets,s=l.getFileManager(t.instanceUuid);for(const e of n)s.copy(e[0],e[1]);a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/move",(async(e,t)=>{try{const n=t.targets,s=l.getFileManager(t.instanceUuid);for(const e of n)await s.move(e[0],e[1]);a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/delete",(async(e,t)=>{try{const n=t.targets,s=l.getFileManager(t.instanceUuid);for(const e of n)s.delete(e);a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/edit",(async(e,t)=>{try{const n=t.target,s=t.text,r=l.getFileManager(t.instanceUuid),o=await r.edit(n,s);a.response(e,o||!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("file/compress",(async(e,t)=>{try{const n=t.source,s=t.targets,r=t.type,o=l.getFileManager(t.instanceUuid);1===r?o.zip(n,s).then((()=>{})).catch((t=>{a.responseError(e,t)})):o.unzip(n,s).then((()=>{})).catch((t=>{a.responseError(e,t)}))}catch(t){a.responseError(e,t)}}))},7948:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1511)),o=s(n(4470)),i=s(n(1017)),a=n(5138),c=s(n(7062)),u=s(n(8005)),l=new r.default;l.all("/",(async e=>{e.body="MCSManager Deamon: Copyright(c) 2021 Suwings | Status: OK.",e.status=200})),l.get("/download/:key/:fileName",(async e=>{const t=e.params.key;try{const n=a.missionPassport.getMission(t,"download");if(!n)throw new Error(e.body="No task, Access denied | 无下载任务，非法访问");const s=c.default.getInstance(n.parameter.instanceUuid);if(!s)throw new Error("实例不存在");const r=s.config.cwd,l=n.parameter.fileName,d=i.default.extname(l),f=new u.default(r);if(!f.check(l))throw new Error(e.body="Access denied | 参数不正确");e.type=d,e.body=o.default.createReadStream(f.toAbsolutePath(l)),a.missionPassport.deleteMission(t)}catch(t){e.body=`下载出错: ${t.message}`,e.status=500}finally{a.missionPassport.deleteMission(t)}})),l.post("/upload/:key",(async e=>{const t=e.params.key,n=e.query.unzip;try{const s=a.missionPassport.getMission(t,"upload");if(!s)throw new Error("Access denied 0x061");const r=c.default.getInstance(s.parameter.instanceUuid);if(!r)throw new Error("Access denied 0x062");const l=s.parameter.uploadDir,d=r.config.cwd,f=e.request.files.file;if(f){const t=f.name,s=i.default.normalize(i.default.join(l,t));if(!u.default.checkFileName(t))throw new Error("Access denied 0x063");const a=new u.default(d);if(!a.checkPath(s))throw new Error("Access denied 0x064");const c=a.toAbsolutePath(s),p=o.default.createReadStream(f.path),h=o.default.createWriteStream(c);return p.pipe(h),p.on("close",(()=>{n&&new u.default(r.config.cwd).unzip(t,"")})),e.body="OK"}e.body="未知原因: 上传失败"}catch(t){e.body=t.message,e.status=500}finally{a.missionPassport.deleteMission(t)}})),t.default=l},675:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(2037)),c=i(n(7411)),u=o(n(4754)),l=n(8963),d=i(n(7062)),f=i(n(3948));var p=null;setInterval((()=>{c.default.cpuUsage((e=>{p={cpuUsage:e,totalmem:a.default.totalmem(),freemem:a.default.freemem(),type:a.default.type(),hostname:a.default.hostname(),loadavg:a.default.loadavg(),platform:a.default.platform(),release:a.default.release(),uptime:a.default.uptime()}}))}),1e3),l.routerApp.on("info/overview",(async e=>{let t=0,n=0;d.default.instances.forEach((e=>{t++,e.status()==f.default.STATUS_RUNNING&&n++}));const s={process:{cpu:process.cpuUsage().system,memory:process.memoryUsage().heapUsed,cwd:process.cwd()},instance:{running:n,total:t},system:p};u.response(e,s)}))},6459:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(1017)),c=i(n(620)),u=o(n(4754)),l=i(n(7062)),d=i(n(4470)),f={};setInterval((function(){for(const e in f){const t=f[e];l.default.forEachForward(e,(n=>{u.msg(new c.default(null,n),"instance/stdout",{instanceUuid:e,text:t})})),delete f[e]}}),100),l.default.on("data",((e,t)=>{if(f[e]){if(f[e].length>4e4)return f[e]+="\n[warning] the output data is too fast, more content has been blocked at this moment in order to ensure stability.\n[警告] 输出流数据过快，为保证稳定性，已屏蔽此刻更多内容....\n";f[e]+=t}else f[e]=t;(async function(e,t){const n=a.default.join(l.default.LOG_DIR,`${e}.log`);d.default.existsSync(l.default.LOG_DIR)||d.default.mkdirsSync(l.default.LOG_DIR);try{const e=d.default.statSync(n);e&&e.size>1048576&&d.default.removeSync(n)}catch(e){}await d.default.writeFile(n,t,{encoding:"utf-8",flag:"a"})})(e,t).then((()=>{})).catch((()=>{}))})),l.default.on("exit",(e=>{l.default.forEachForward(e.instanceUuid,(t=>{u.msg(new c.default(null,t),"instance/stopped",{instanceUuid:e.instanceUuid,instanceName:e.instanceName})}))})),l.default.on("open",(e=>{l.default.forEachForward(e.instanceUuid,(t=>{u.msg(new c.default(null,t),"instance/opened",{instanceUuid:e.instanceUuid,instanceName:e.instanceName})}))})),l.default.on("failure",(e=>{l.default.forEachForward(e.instanceUuid,(t=>{u.msg(new c.default(null,t),"instance/failure",{instanceUuid:e.instanceUuid,instanceName:e.instanceName})}))}))},2732:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const i=n(8963),a=n(5138),c=o(n(4754));i.routerApp.on("passport/register",((e,t)=>{const n=t.name,s=t.password,r=t.parameter,o=t.count,i=(new Date).getTime(),u=i+36e5;if(!n||!s)throw new Error("不可定义任务名或密钥为空");a.missionPassport.registerMission(s,{name:n,parameter:r,count:o,start:i,end:u}),c.response(e,!0)}))},9439:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(8963),c=o(n(4754)),u=i(n(7522));a.routerApp.on("schedule/register",((e,t)=>{u.default.registerScheduleJob(t),c.response(e,!0)})),a.routerApp.on("schedule/list",((e,t)=>{c.response(e,u.default.listScheduleJob(t.instanceUuid))})),a.routerApp.on("schedule/delete",((e,t)=>{u.default.deleteScheduleTask(t.instanceUuid,t.name),c.response(e,!0)}))},4527:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(n(4754)),c=n(8963),u=n(5138),l=i(n(7062)),d=i(n(3541)),f=i(n(5755));c.routerApp.use((async(e,t,n,s)=>"stream/auth"===e?s():e.startsWith("stream")?t.session.stream&&!0===t.session.stream.check&&"STREAM"===t.session.type?await s():a.error(t,"error","权限不足，非法访问"):await s())),c.routerApp.on("stream/auth",((e,t)=>{try{const n=t.password,s=u.missionPassport.getMission(n,"stream_channel");if(!s)throw new Error("任务不存在");const r=l.default.getInstance(s.parameter.instanceUuid);if(!r)throw new Error("实例不存在");d.default.info(`会话 ${e.socket.id} ${e.socket.handshake.address} 数据流通道身份验证成功`),e.session.id=e.socket.id,e.session.login=!0,e.session.type="STREAM",e.session.stream={check:!0,instanceUuid:r.instanceUuid},l.default.forward(r.instanceUuid,e.socket),d.default.info(`会话 ${e.socket.id} ${e.socket.handshake.address} 已与 ${r.instanceUuid} 建立数据通道`),e.socket.on("disconnect",(()=>{l.default.stopForward(r.instanceUuid,e.socket),d.default.info(`会话 ${e.socket.id} ${e.socket.handshake.address} 已与 ${r.instanceUuid} 断开数据通道`)})),a.response(e,!0)}catch(t){a.responseError(e,t)}})),c.routerApp.on("stream/detail",(async e=>{try{const t=e.session.stream.instanceUuid,n=l.default.getInstance(t);a.response(e,{instanceUuid:n.instanceUuid,started:n.startCount,status:n.status(),config:n.config,info:n.info})}catch(t){a.responseError(e,t)}})),c.routerApp.on("stream/input",(async(e,t)=>{try{const n=t.command,s=e.session.stream.instanceUuid,r=l.default.getInstance(s);await r.exec(new f.default(n))}catch(t){a.responseError(e,t)}}))},1376:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DockerManager=void 0;const r=s(n(4856));class o{constructor(e){this.docker=null,this.docker=new r.default(e)}getDocker(){return this.docker}static setBuilerProgress(e,t){o.builerProgress.set(e,t)}static getBuilerProgress(e){return o.builerProgress.get(e)}async startBuildImage(e,t){try{o.setBuilerProgress(t,1);const n=await this.docker.buildImage({context:e,src:["Dockerfile"]},{t});await new Promise(((e,t)=>{this.docker.modem.followProgress(n,((n,s)=>n?t(n):e(s)))})),o.setBuilerProgress(t,2)}catch(e){o.setBuilerProgress(t,-1)}}}t.DockerManager=o,o.builerProgress=new Map},1699:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getFileManager=void 0;const r=s(n(7062)),o=s(n(8005));t.getFileManager=function(e){const t=r.default.getInstance(e);if(!t)throw new Error(`实例 ${e} 不存在`);const n=t.config.cwd;return new o.default(n)}},5091:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.initKoa=void 0;const r=s(n(6466)),o=s(n(5004)),i=s(n(7948));t.initKoa=function(){const e=new r.default;return e.use(o.default({multipart:!0,formidable:{maxFileSize:0xfa00000000}})),e.use((async(e,t)=>{await t(),e.response.set("Access-Control-Allow-Origin","*"),e.response.set("Access-Control-Allow-Methods","POST, GET, PUT, DELETE, OPTIONS"),e.response.set("Access-Control-Allow-Headers","Content-Type, Cookie, Accept-Encoding, User-Agent, Host, Referer, X-Requested-With, Accept, Accept-Language, Cache-Control, Connection"),e.response.set("X-Power-by","MCSManager")})),e.use(i.default.routes()).use(i.default.allowedMethods()),e}},3541:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(8094));i.configure({appenders:{out:{type:"stdout",layout:{type:"pattern",pattern:"[%d{MM/dd hh:mm:ss}] [%[%p%]] %m"}},app:{type:"file",filename:"logs/current.log",layout:{type:"pattern",pattern:"%d %p %m"}}},categories:{default:{appenders:["out","app"],level:"info"}}});const a=i.getLogger("default");t.default=a},5138:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.missionPassport=void 0;const n=new class{constructor(){this.missions=new Map,setInterval((()=>{const e=(new Date).getTime();this.missions.forEach(((t,n)=>{e>t.end&&this.missions.delete(n)}))}),1e3)}registerMission(e,t){if(this.missions.has(e))throw new Error("Duplicate primary key, failed to create task");this.missions.set(e,t)}getMission(e,t){if(!this.missions.has(e))return null;const n=this.missions.get(e);return n.name===t?n:null}deleteMission(e){this.missions.delete(e)}};t.missionPassport=n},4754:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.broadcast=t.socketObjects=t.delGlobalSocket=t.addGlobalSocket=t.stringify=t.parse=t.error=t.msg=t.responseError=t.response=t.Packet=void 0;const r=s(n(620)),o=s(n(3541)),i=new Map;class a{constructor(e=null,t=200,n=null,s=null){this.uuid=e,this.status=t,this.event=n,this.data=s}}function c(e,t,n){const s=new a(e.uuid,200,t,n);e.socket.emit(t,s)}t.Packet=a,t.response=function(e,t){const n=new a(e.uuid,200,e.event,t);e.socket.emit(e.event,n)},t.responseError=function(e,t){let n="";n=t?t.toString():t;const s=new a(e.uuid,500,e.event,n);o.default.error(`会话 ${e.socket.id}(${e.socket.handshake.address})/${e.event} 响应数据时异常:\n`,t),e.socket.emit(e.event,s)},t.msg=c,t.error=function(e,t,n){const s=new a(e.uuid,500,t,n);o.default.error(`会话 ${e.socket.id}(${e.socket.handshake.address})/${t} 响应数据时异常:\n`,n),e.socket.emit(t,s)},t.parse=function(e){if("object"==typeof e)return new a(e.uuid||null,e.status,e.event,e.data);const t=JSON.parse(e);return new a(null,t.status,t.event,t.data)},t.stringify=function(e){return JSON.stringify(e)},t.addGlobalSocket=function(e){i.set(e.id,e)},t.delGlobalSocket=function(e){i.delete(e.id)},t.socketObjects=function(){return i},t.broadcast=function(e,t){i.forEach((n=>{c(new r.default(null,n),e,t)}))}},8963:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.navigation=t.routerApp=void 0;const r=n(1239),o=s(n(3541)),i=s(n(620)),a=n(4754);class c extends r.EventEmitter{constructor(){super(),this.middlewares=[]}emitRouter(e,t,n){try{super.emit(e,t,n)}catch(e){a.responseError(t,e)}return this}on(e,t){return super.on(e,t)}use(e){this.middlewares.push(e)}getMiddlewares(){return this.middlewares}}t.routerApp=new c,t.navigation=function(e){const n={};for(const s of t.routerApp.getMiddlewares())e.use(((t,r)=>{const a=t[1];if(!a)return o.default.info(`session ${e.id} request data protocol format is incorrect`);const c=new i.default(a.uuid,e,n);s(t[0],c,a.data,r)}));for(const s of t.routerApp.eventNames())e.on(s,(r=>{if(!r)return o.default.info(`session ${e.id} request data protocol format is incorrect`);const a=new i.default(r.uuid,e,n,s.toString());t.routerApp.emitRouter(s,a,r.data)}));const s=new i.default(null,e,n);t.routerApp.emitRouter("connection",s,null)},o.default.info("正在读取业务路由与相关中间件..."),n(4765),n(2732),n(675),n(9366),n(6459),n(1632),n(4527),n(4129),n(9439),o.default.info(`装载完毕, 共路由 ${t.routerApp.eventNames().length} 个, 中间件 ${t.routerApp.middlewares.length} 个`)},8005:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1017)),o=s(n(4470)),i=n(383),a="非法访问路径";t.default=class{constructor(e=""){this.topPath=null,this.cwd=".",r.default.isAbsolute(e)?this.topPath=r.default.normalize(e):this.topPath=r.default.normalize(r.default.join(process.cwd(),e))}toAbsolutePath(e=""){return r.default.normalize(r.default.join(this.topPath,this.cwd,e))}checkPath(e){const t=this.toAbsolutePath(e),n=this.topPath;return 0===t.indexOf(n)}check(e){return this.checkPath(e)&&o.default.existsSync(this.toAbsolutePath(e))}cd(e){if(!this.check(e))throw new Error(a);this.cwd=r.default.normalize(r.default.join(this.cwd,e))}list(){const e=o.default.readdirSync(this.toAbsolutePath()),t=[],n=[];return e.forEach((e=>{const s=o.default.statSync(this.toAbsolutePath(e));s.isFile()?t.push({name:e,type:1,size:s.size,time:s.atime.toString()}):n.push({name:e,type:0,size:s.size,time:s.atime.toString()})})),t.sort(((e,t)=>e.name>t.name?1:-1)),n.sort(((e,t)=>e.name>t.name?1:-1)),n.concat(t)}async readFile(e){if(!this.check(e))throw new Error(a);const t=this.toAbsolutePath(e);return await o.default.readFile(t,{encoding:"utf-8"})}async writeFile(e,t){if(!this.check(e))throw new Error(a);const n=this.toAbsolutePath(e);return await o.default.writeFile(n,t,{encoding:"utf-8"})}async copy(e,t){if(!this.checkPath(t)||!this.check(e))throw new Error(a);const n=this.toAbsolutePath(e);return t=this.toAbsolutePath(t),await o.default.copy(n,t)}mkdir(e){if(!this.checkPath(e))throw new Error(a);const t=this.toAbsolutePath(e);return o.default.mkdirSync(t)}async delete(e){if(!this.check(e))throw new Error(a);const t=this.toAbsolutePath(e);return new Promise(((e,n)=>{o.default.remove(t,(t=>{t?n(t):e(!0)}))}))}async move(e,t){if(!this.check(e))throw new Error(a);if(!this.checkPath(t))throw new Error(a);const n=this.toAbsolutePath(e);t=this.toAbsolutePath(t),await o.default.move(n,t)}async unzip(e,t){if(!this.check(e)||!this.checkPath(t))throw new Error(a);return await i.decompress(this.toAbsolutePath(e),this.toAbsolutePath(t))}async zip(e,t){if(!this.checkPath(e))throw new Error(a);const n=this.toAbsolutePath(e),s=[];for(const e of t)this.check(e)&&s.push(this.toAbsolutePath(e));return await i.compress(n,s)}async edit(e,t){if(!this.check(e))throw new Error(a);if(t)return await this.writeFile(e,t);{const t=this.toAbsolutePath(e);if(o.default.statSync(t).size>4194304)throw new Error("超出最大文件编辑限制");return await this.readFile(e)}}rename(e,t){if(!this.check(e))throw new Error(a);if(!this.checkPath(t))throw new Error(a);const n=this.toAbsolutePath(e),s=this.toAbsolutePath(t);o.default.renameSync(n,s)}static checkFileName(e){const t=["/","\\","|","?","*",">","<",";",'"',"'"];for(const n of t)if(e.includes(n))return!1;return!0}}},7062:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(4470)),o=s(n(1017)),i=s(n(3948)),a=s(n(1239)),c=s(n(107)),u=s(n(3541)),l=n(5828),d=s(n(9732)),f=s(n(453)),p=s(n(9231)),h=n(8412),_=s(n(7338)),g=s(n(7522)),m=s(n(2924)),y=o.default.join(process.cwd(),"data/InstanceData");r.default.existsSync(y)||r.default.mkdirsSync(y);class w extends a.default{constructor(){super(),this.LOG_DIR="data/InstanceLog/",this.instances=new Map,this.instanceStream=new p.default}autoStart(){this.instances.forEach((e=>{e.config.eventTask.autoStart&&e.exec(new m.default).then((()=>{u.default.info(`实例 ${e.config.nickname} ${e.instanceUuid} 自动启动指令已发出`)})).catch((t=>{u.default.error(`实例 ${e.config.nickname} ${e.instanceUuid} 自动启动时错误: ${t}`)}))}))}loadInstances(){d.default.list("InstanceConfig").forEach((e=>{const t=d.default.load("InstanceConfig",f.default,e),n=new i.default(e,t);n.forceExec(new _.default).then((e=>{})).catch((e=>{})),this.addInstance(n)})),this.autoStart()}createInstance(e){const t=l.v4().replace(/-/gim,""),n=new i.default(t,new f.default);return e.cwd&&"."!==e.cwd||(e.cwd=`${y}/${n.instanceUuid}`,r.default.existsSync(e.cwd)||r.default.mkdirsSync(e.cwd)),n.parameters(e),this.addInstance(n),n}addInstance(e){if(null==e.instanceUuid)throw new Error("无法新增某实例，因为实例UUID为空");if(this.instances.has(e.instanceUuid))throw new Error(`The application instance ${e.instanceUuid} already exists.`);this.instances.set(e.instanceUuid,e),e.on("data",((...t)=>{this.emit("data",e.instanceUuid,...t)})),e.on("exit",((...t)=>{this.emit("exit",{instanceUuid:e.instanceUuid,instanceName:e.config.nickname},...t)})),e.on("open",((...t)=>{this.emit("open",{instanceUuid:e.instanceUuid,instanceName:e.config.nickname},...t)})),e.on("failure",((...t)=>{this.emit("failure",{instanceUuid:e.instanceUuid,instanceName:e.config.nickname},...t)}))}removeInstance(e,t){const n=this.getInstance(e);if(n)return n.destroy(),this.instances.delete(e),d.default.delete("InstanceConfig",e),g.default.deleteInstanceAllTask(e),t&&r.default.remove(n.config.cwd,(e=>{})),!0;throw new Error("Instance does not exist")}forward(e,t){try{this.instanceStream.requestForward(t,e)}catch(e){}}stopForward(e,t){try{this.instanceStream.cannelForward(t,e)}catch(e){}}forEachForward(e,t){this.instanceStream.forwardViaCallback(e,(e=>{t(e)}))}getInstance(e){return this.instances.get(e)}getQueryMapWrapper(){return new h.QueryMapWrapper(this.instances)}exists(e){return this.instances.has(e)}async exit(){for(const e of this.instances){const t=e[1];t.status()!=i.default.STATUS_STOP&&(u.default.info(`Instance ${t.config.nickname} (${t.instanceUuid}) is running or busy, and is being forced to end.`),await t.execCommand(new c.default)),d.default.store("InstanceConfig",t.instanceUuid,t.config),u.default.info(`Instance ${t.config.nickname} (${t.instanceUuid}) saved successfully.`)}}}t.default=new w},7522:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(7344)),o=s(n(7062)),i=s(n(9732)),a=s(n(3541)),c=s(n(2924)),u=s(n(3265)),l=s(n(5755)),d=s(n(6530)),f=s(n(107));class p{constructor(){this.instanceUuid="",this.name="",this.count=1,this.time="",this.action="",this.payload="",this.type=1}}class h{constructor(e,t){this.callback=e,this.time=t,this.job=0,this.job=setInterval(e,1e3*t)}cancel(){clearInterval(this.job)}}class _{constructor(e,t){this.config=e,this.job=t}}t.default=new class{constructor(){this.taskMap=new Map,this.taskJobMap=new Map,i.default.list("TaskConfig").forEach((e=>{const t=i.default.load("TaskConfig",p,e);this.registerScheduleJob(t,!1)}))}registerScheduleJob(e,t=!0){const n=`${e.instanceUuid}`;if(this.taskMap.has(n)||this.taskMap.set(n,[]),!this.checkTask(n,e.name))throw new Error("已存在重复的任务");let s;t&&a.default.info(`创建计划任务 ${e.name}:\n${JSON.stringify(e)}`),s=1===e.type?new h((()=>{this.action(e),-1!==e.count&&(1===e.count?(s.cancel(),this.deleteTask(n,e.name)):(e.count--,this.updateTaskConfig(n,e.name,e)))}),Number(e.time)):r.default.scheduleJob(e.time,(()=>{this.action(e),-1!==e.count&&(1===e.count?(s.cancel(),this.deleteTask(n,e.name)):(e.count--,this.updateTaskConfig(n,e.name,e)))}));const o=new _(e,s);this.taskMap.get(n).push(o),t&&i.default.store("TaskConfig",o.config.name,o.config),t&&a.default.info(`创建计划任务 ${e.name} 完毕`)}listScheduleJob(e){const t=`${e}`,n=this.taskMap.get(t)||[],s=[];return n.forEach((e=>{s.push(e.config)})),s}async action(e){try{const t=e.payload,n=e.instanceUuid,s=o.default.getInstance(n);if(!s)return this.deleteScheduleTask(e.instanceUuid,e.name);const r=s.status();"start"===e.action&&0===r&&s.exec(new c.default("ScheduleJob")),"stop"===e.action&&3===r&&s.exec(new u.default),"restart"===e.action&&3===r&&s.exec(new d.default),"command"===e.action&&3===r&&s.exec(new l.default(t)),"kill"===e.action&&s.exec(new f.default)}catch(t){a.default.error(`实例 ${e.instanceUuid} 计划任务 ${e.name} 执行错误: \n ${t} `)}}deleteInstanceAllTask(e){const t=this.listScheduleJob(e);t&&t.forEach((t=>{this.deleteScheduleTask(e,t.name)}))}deleteScheduleTask(e,t){const n=`${e}`;this.deleteTask(n,t)}deleteTask(e,t){this.taskMap.get(e).forEach(((e,n,s)=>{e.config.name===t&&(e.job.cancel(),s.splice(n,1))})),i.default.delete("TaskConfig",t)}checkTask(e,t){let n=!0;return this.taskMap.get(e).forEach(((e,s,r)=>{e.config.name===t&&(n=!1)})),n}updateTaskConfig(e,t,n){const s=this.taskMap.get(e);for(const e in s)if(s[e].config.name===t){s[e].config=n;break}}}},158:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(4521)),c=o(n(4754)),u=i(n(7062)),l=n(5533),d=i(n(3541)),f=i(n(2924)),p=i(n(3265)),h=i(n(107)),_=i(n(5755)),g=a.default.createInterface({input:process.stdin,output:process.stdout});console.log('[终端] 守护进程拥有基本的交互功能，请输入"help"查看更多信息'),function e(){g.question("> ",(t=>{try{const n=t.split(" ");d.default.info(`[Terminal] ${t}`);const s=function(e,t,n,s){if("instance"===e)return"start"===t?(u.default.getInstance(n).exec(new f.default("Terminal")),"Done."):"stop"===t?(u.default.getInstance(n).exec(new p.default),"Done."):"kill"===t?(u.default.getInstance(n).exec(new h.default),"Done."):"send"===t?(u.default.getInstance(n).exec(new _.default(s)),"Done."):"Parameter error";if("instances"===e){const e=u.default.instances;let t="instance name | instance UUID | status code\n";return e.forEach((e=>{t+=`${e.config.nickname} ${e.instanceUuid} ${e.status()}\n`})),t+="\nStatus Explanation:\n Busy=-1;Stop=0;Stopping=1;Starting=2;Running=3;\n",t}if("sockets"===e){const e=c.socketObjects();let t="IP address   |   identifier\n";return e.forEach((e=>{t+=`${e.handshake.address} ${e.id}\n`})),t+=`Total ${e.size} online.\n`,t}if("key"==e)return l.globalConfiguration.config.key;if("exit"==e)try{d.default.info("Preparing to shut down the daemon..."),u.default.exit(),d.default.info("The data is saved, thanks for using, goodbye!"),d.default.info("closed."),process.exit(0)}catch(e){d.default.error("Failed to end the program. Please check the file permissions and try again. If you still can't close it, please use Ctrl+C to close.",e)}return"help"==e?(console.log("----------- Help document -----------"),console.log(" instances view all instances"),console.log(" Sockets view all linkers"),console.log(" key view key"),console.log(" exit to close this program (recommended method)"),console.log(" instance start <UUID> to start the specified instance"),console.log(" instance stop <UUID> to start the specified instance"),console.log(" instance kill <UUID> to start the specified instance"),console.log(" instance send <UUID> <CMD> to send a command to the instance"),console.log("----------- Help document -----------"),"\n"):void 0}(n[0],n[1],n[2],n[3]);s?console.log(s):console.log(`Command ${t} does not exist, type help to get help.`)}catch(e){d.default.error("[Terminal]",e)}finally{e()}}))}()},5233:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getVersion=t.initVersionManager=void 0;const a=o(n(4470)),c=i(n(2887)),u=i(n(3541)),l="package.json";t.initVersionManager=function(){try{if(c.default.set("version","Unknown"),a.existsSync(l)){const e=JSON.parse(a.readFileSync(l,{encoding:"utf-8"}));e.version&&c.default.set("version",e.version)}}catch(e){u.default.error("版本检查失败",e)}},t.getVersion=function(){return c.default.get("version","Unknown")}},1511:e=>{e.exports=require("@koa/router")},7416:e=>{e.exports=require("compressing")},4856:e=>{e.exports=require("dockerode")},1239:e=>{e.exports=require("events")},4470:e=>{e.exports=require("fs-extra")},5135:e=>{e.exports=require("iconv-lite")},6466:e=>{e.exports=require("koa")},5004:e=>{e.exports=require("koa-body")},8094:e=>{e.exports=require("log4js")},7344:e=>{e.exports=require("node-schedule")},7411:e=>{e.exports=require("os-utils")},3691:e=>{e.exports=require("pidusage")},8231:e=>{e.exports=require("properties")},3952:e=>{e.exports=require("socket.io")},5828:e=>{e.exports=require("uuid")},9066:e=>{e.exports=require("yaml")},2081:e=>{e.exports=require("child_process")},1891:e=>{e.exports=require("dgram")},3685:e=>{e.exports=require("http")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},4521:e=>{e.exports=require("readline")}},t={};!function n(s){var r=t[s];if(void 0!==r)return r.exports;var o=t[s]={exports:{}};return e[s].call(o.exports,o,o.exports,n),o.exports}(6672)})();